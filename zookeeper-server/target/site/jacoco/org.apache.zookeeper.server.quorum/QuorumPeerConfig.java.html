<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QuorumPeerConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache ZooKeeper - Server</a> &gt; <a href="index.source.html" class="el_package">org.apache.zookeeper.server.quorum</a> &gt; <span class="el_source">QuorumPeerConfig.java</span></div><h1>QuorumPeerConfig.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.zookeeper.server.quorum;

import static org.apache.zookeeper.common.NetUtils.formatInetAddr;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.StringReader;
import java.io.Writer;
import java.net.InetAddress;
import java.net.InetSocketAddress;
import java.nio.file.Files;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Properties;
import org.apache.yetus.audience.InterfaceAudience;
import org.apache.zookeeper.common.AtomicFileWritingIdiom;
import org.apache.zookeeper.common.AtomicFileWritingIdiom.OutputStreamStatement;
import org.apache.zookeeper.common.AtomicFileWritingIdiom.WriterStatement;
import org.apache.zookeeper.common.ClientX509Util;
import org.apache.zookeeper.common.PathUtils;
import org.apache.zookeeper.common.StringUtils;
import org.apache.zookeeper.metrics.impl.DefaultMetricsProvider;
import org.apache.zookeeper.server.ZooKeeperServer;
import org.apache.zookeeper.server.auth.ProviderRegistry;
import org.apache.zookeeper.server.quorum.QuorumPeer.LearnerType;
import org.apache.zookeeper.server.quorum.QuorumPeer.QuorumServer;
import org.apache.zookeeper.server.quorum.auth.QuorumAuth;
import org.apache.zookeeper.server.quorum.flexible.QuorumHierarchical;
import org.apache.zookeeper.server.quorum.flexible.QuorumMaj;
import org.apache.zookeeper.server.quorum.flexible.QuorumOracleMaj;
import org.apache.zookeeper.server.quorum.flexible.QuorumVerifier;
import org.apache.zookeeper.server.util.JvmPauseMonitor;
import org.apache.zookeeper.server.util.VerifyingFileFactory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.MDC;

@InterfaceAudience.Public
<span class="nc" id="L64">public class QuorumPeerConfig {</span>

<span class="nc" id="L66">    private static final Logger LOG = LoggerFactory.getLogger(QuorumPeerConfig.class);</span>
    private static final int UNSET_SERVERID = -1;
    public static final String nextDynamicConfigFileSuffix = &quot;.dynamic.next&quot;;

<span class="nc" id="L70">    private static boolean standaloneEnabled = true;</span>
<span class="nc" id="L71">    private static boolean reconfigEnabled = false;</span>

    protected InetSocketAddress clientPortAddress;
    protected InetSocketAddress secureClientPortAddress;
<span class="nc" id="L75">    protected boolean sslQuorum = false;</span>
<span class="nc" id="L76">    protected boolean shouldUsePortUnification = false;</span>
    protected int observerMasterPort;
<span class="nc" id="L78">    protected boolean sslQuorumReloadCertFiles = false;</span>
    protected File dataDir;
    protected File dataLogDir;
<span class="nc" id="L81">    protected String dynamicConfigFileStr = null;</span>
<span class="nc" id="L82">    protected String configFileStr = null;</span>
<span class="nc" id="L83">    protected int tickTime = ZooKeeperServer.DEFAULT_TICK_TIME;</span>
<span class="nc" id="L84">    protected int maxClientCnxns = 60;</span>
    /** defaults to -1 if not set explicitly */
<span class="nc" id="L86">    protected int minSessionTimeout = -1;</span>
    /** defaults to -1 if not set explicitly */
<span class="nc" id="L88">    protected int maxSessionTimeout = -1;</span>
<span class="nc" id="L89">    protected String metricsProviderClassName = DefaultMetricsProvider.class.getName();</span>
<span class="nc" id="L90">    protected Properties metricsProviderConfiguration = new Properties();</span>
<span class="nc" id="L91">    protected boolean localSessionsEnabled = false;</span>
<span class="nc" id="L92">    protected boolean localSessionsUpgradingEnabled = false;</span>
    /** defaults to -1 if not set explicitly */
<span class="nc" id="L94">    protected int clientPortListenBacklog = -1;</span>

    protected int initLimit;
    protected int syncLimit;
    protected int connectToLearnerMasterLimit;
<span class="nc" id="L99">    protected int electionAlg = 3;</span>
<span class="nc" id="L100">    protected int electionPort = 2182;</span>
<span class="nc" id="L101">    protected boolean quorumListenOnAllIPs = false;</span>

<span class="nc" id="L103">    protected long serverId = UNSET_SERVERID;</span>

<span class="nc" id="L105">    protected QuorumVerifier quorumVerifier = null, lastSeenQuorumVerifier = null;</span>
<span class="nc" id="L106">    protected int snapRetainCount = 3;</span>
<span class="nc" id="L107">    protected int purgeInterval = 0;</span>
<span class="nc" id="L108">    protected boolean syncEnabled = true;</span>

    protected String initialConfig;

<span class="nc" id="L112">    protected LearnerType peerType = LearnerType.PARTICIPANT;</span>

    /**
     * Configurations for the quorumpeer-to-quorumpeer sasl authentication
     */
<span class="nc" id="L117">    protected boolean quorumServerRequireSasl = false;</span>
<span class="nc" id="L118">    protected boolean quorumLearnerRequireSasl = false;</span>
<span class="nc" id="L119">    protected boolean quorumEnableSasl = false;</span>
<span class="nc" id="L120">    protected String quorumServicePrincipal = QuorumAuth.QUORUM_KERBEROS_SERVICE_PRINCIPAL_DEFAULT_VALUE;</span>
<span class="nc" id="L121">    protected String quorumLearnerLoginContext = QuorumAuth.QUORUM_LEARNER_SASL_LOGIN_CONTEXT_DFAULT_VALUE;</span>
<span class="nc" id="L122">    protected String quorumServerLoginContext = QuorumAuth.QUORUM_SERVER_SASL_LOGIN_CONTEXT_DFAULT_VALUE;</span>
    protected int quorumCnxnThreadsSize;

    // multi address related configs
<span class="nc" id="L126">    private boolean multiAddressEnabled = Boolean.parseBoolean(</span>
<span class="nc" id="L127">        System.getProperty(QuorumPeer.CONFIG_KEY_MULTI_ADDRESS_ENABLED, QuorumPeer.CONFIG_DEFAULT_MULTI_ADDRESS_ENABLED));</span>
<span class="nc" id="L128">    private boolean multiAddressReachabilityCheckEnabled =</span>
<span class="nc" id="L129">        Boolean.parseBoolean(System.getProperty(QuorumPeer.CONFIG_KEY_MULTI_ADDRESS_REACHABILITY_CHECK_ENABLED, &quot;true&quot;));</span>
<span class="nc" id="L130">    private int multiAddressReachabilityCheckTimeoutMs =</span>
<span class="nc" id="L131">        Integer.parseInt(System.getProperty(QuorumPeer.CONFIG_KEY_MULTI_ADDRESS_REACHABILITY_CHECK_TIMEOUT_MS,</span>
<span class="nc" id="L132">                                            String.valueOf(MultipleAddresses.DEFAULT_TIMEOUT.toMillis())));</span>

    protected String oraclePath;

    /**
     * Minimum snapshot retain count.
     * @see org.apache.zookeeper.server.PurgeTxnLog#purge(File, File, int)
     */
<span class="nc" id="L140">    private final int MIN_SNAP_RETAIN_COUNT = 3;</span>

    /**
     * JVM Pause Monitor feature switch
     */
<span class="nc" id="L145">    protected boolean jvmPauseMonitorToRun = false;</span>
    /**
     * JVM Pause Monitor warn threshold in ms
     */
<span class="nc" id="L149">    protected long jvmPauseWarnThresholdMs = JvmPauseMonitor.WARN_THRESHOLD_DEFAULT;</span>
    /**
     * JVM Pause Monitor info threshold in ms
     */
<span class="nc" id="L153">    protected long jvmPauseInfoThresholdMs = JvmPauseMonitor.INFO_THRESHOLD_DEFAULT;</span>
    /**
     * JVM Pause Monitor sleep time in ms
     */
<span class="nc" id="L157">    protected long jvmPauseSleepTimeMs = JvmPauseMonitor.SLEEP_TIME_MS_DEFAULT;</span>

    @SuppressWarnings(&quot;serial&quot;)
    public static class ConfigException extends Exception {

        public ConfigException(String msg) {
<span class="nc" id="L163">            super(msg);</span>
<span class="nc" id="L164">        }</span>
        public ConfigException(String msg, Exception e) {
<span class="nc" id="L166">            super(msg, e);</span>
<span class="nc" id="L167">        }</span>

    }

    /**
     * Parse a ZooKeeper configuration file
     * @param path the patch of the configuration file
     * @throws ConfigException error processing configuration
     */
    public void parse(String path) throws ConfigException {
<span class="nc" id="L177">        LOG.info(&quot;Reading configuration from: &quot; + path);</span>

        try {
<span class="nc" id="L180">            File configFile = (new VerifyingFileFactory.Builder(LOG)</span>
<span class="nc" id="L181">                .warnForRelativePath()</span>
<span class="nc" id="L182">                .failForNonExistingPath()</span>
<span class="nc" id="L183">                .build()).create(path);</span>

<span class="nc" id="L185">            Properties cfg = new Properties();</span>
<span class="nc" id="L186">            try (FileInputStream in = new FileInputStream(configFile)) {</span>
<span class="nc" id="L187">                cfg.load(in);</span>
<span class="nc" id="L188">                configFileStr = path;</span>
            }

            /* Read entire config file as initial configuration */
<span class="nc" id="L192">            initialConfig = new String(Files.readAllBytes(configFile.toPath()));</span>

<span class="nc" id="L194">            parseProperties(cfg);</span>
<span class="nc" id="L195">        } catch (IOException e) {</span>
<span class="nc" id="L196">            throw new ConfigException(&quot;Error processing &quot; + path, e);</span>
<span class="nc" id="L197">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L198">            throw new ConfigException(&quot;Error processing &quot; + path, e);</span>
<span class="nc" id="L199">        }</span>

<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (dynamicConfigFileStr != null) {</span>
            try {
<span class="nc" id="L203">                Properties dynamicCfg = new Properties();</span>
<span class="nc" id="L204">                try (FileInputStream inConfig = new FileInputStream(dynamicConfigFileStr)) {</span>
<span class="nc" id="L205">                    dynamicCfg.load(inConfig);</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">                    if (dynamicCfg.getProperty(&quot;version&quot;) != null) {</span>
<span class="nc" id="L207">                        throw new ConfigException(&quot;dynamic file shouldn't have version inside&quot;);</span>
                    }

<span class="nc" id="L210">                    String version = getVersionFromFilename(dynamicConfigFileStr);</span>
                    // If there isn't any version associated with the filename,
                    // the default version is 0.
<span class="nc bnc" id="L213" title="All 2 branches missed.">                    if (version != null) {</span>
<span class="nc" id="L214">                        dynamicCfg.setProperty(&quot;version&quot;, version);</span>
                    }
                }
<span class="nc" id="L217">                setupQuorumPeerConfig(dynamicCfg, false);</span>

<span class="nc" id="L219">            } catch (IOException e) {</span>
<span class="nc" id="L220">                throw new ConfigException(&quot;Error processing &quot; + dynamicConfigFileStr, e);</span>
<span class="nc" id="L221">            } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L222">                throw new ConfigException(&quot;Error processing &quot; + dynamicConfigFileStr, e);</span>
<span class="nc" id="L223">            }</span>
<span class="nc" id="L224">            File nextDynamicConfigFile = new File(configFileStr + nextDynamicConfigFileSuffix);</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">            if (nextDynamicConfigFile.exists()) {</span>
                try {
<span class="nc" id="L227">                    Properties dynamicConfigNextCfg = new Properties();</span>
<span class="nc" id="L228">                    try (FileInputStream inConfigNext = new FileInputStream(nextDynamicConfigFile)) {</span>
<span class="nc" id="L229">                        dynamicConfigNextCfg.load(inConfigNext);</span>
                    }
<span class="nc" id="L231">                    boolean isHierarchical = false;</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">                    for (Entry&lt;Object, Object&gt; entry : dynamicConfigNextCfg.entrySet()) {</span>
<span class="nc" id="L233">                        String key = entry.getKey().toString().trim();</span>
<span class="nc bnc" id="L234" title="All 4 branches missed.">                        if (key.startsWith(&quot;group&quot;) || key.startsWith(&quot;weight&quot;)) {</span>
<span class="nc" id="L235">                            isHierarchical = true;</span>
<span class="nc" id="L236">                            break;</span>
                        }
<span class="nc" id="L238">                    }</span>
<span class="nc" id="L239">                    lastSeenQuorumVerifier = createQuorumVerifier(dynamicConfigNextCfg, isHierarchical);</span>
<span class="nc" id="L240">                } catch (IOException e) {</span>
<span class="nc" id="L241">                    LOG.warn(&quot;NextQuorumVerifier is initiated to null&quot;);</span>
<span class="nc" id="L242">                }</span>
            }
        }
<span class="nc" id="L245">    }</span>

    // This method gets the version from the end of dynamic file name.
    // For example, &quot;zoo.cfg.dynamic.0&quot; returns initial version &quot;0&quot;.
    // &quot;zoo.cfg.dynamic.1001&quot; returns version of hex number &quot;0x1001&quot;.
    // If a dynamic file name doesn't have any version at the end of file,
    // e.g. &quot;zoo.cfg.dynamic&quot;, it returns null.
    public static String getVersionFromFilename(String filename) {
<span class="nc" id="L253">        int i = filename.lastIndexOf('.');</span>
<span class="nc bnc" id="L254" title="All 4 branches missed.">        if (i &lt; 0 || i &gt;= filename.length()) {</span>
<span class="nc" id="L255">            return null;</span>
        }

<span class="nc" id="L258">        String hexVersion = filename.substring(i + 1);</span>
        try {
<span class="nc" id="L260">            long version = Long.parseLong(hexVersion, 16);</span>
<span class="nc" id="L261">            return Long.toHexString(version);</span>
<span class="nc" id="L262">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L263">            return null;</span>
        }
    }

    /**
     * Parse config from a Properties.
     * @param zkProp Properties to parse from.
     * @throws IOException
     * @throws ConfigException
     */
    public void parseProperties(Properties zkProp) throws IOException, ConfigException {
<span class="nc" id="L274">        int clientPort = 0;</span>
<span class="nc" id="L275">        int secureClientPort = 0;</span>
<span class="nc" id="L276">        int observerMasterPort = 0;</span>
<span class="nc" id="L277">        String clientPortAddress = null;</span>
<span class="nc" id="L278">        String secureClientPortAddress = null;</span>
<span class="nc" id="L279">        VerifyingFileFactory vff = new VerifyingFileFactory.Builder(LOG).warnForRelativePath().build();</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">        for (Entry&lt;Object, Object&gt; entry : zkProp.entrySet()) {</span>
<span class="nc" id="L281">            String key = entry.getKey().toString().trim();</span>
<span class="nc" id="L282">            String value = entry.getValue().toString().trim();</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">            if (key.equals(&quot;dataDir&quot;)) {</span>
<span class="nc" id="L284">                dataDir = vff.create(value);</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">            } else if (key.equals(&quot;dataLogDir&quot;)) {</span>
<span class="nc" id="L286">                dataLogDir = vff.create(value);</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">            } else if (key.equals(&quot;clientPort&quot;)) {</span>
<span class="nc" id="L288">                clientPort = Integer.parseInt(value);</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">            } else if (key.equals(&quot;localSessionsEnabled&quot;)) {</span>
<span class="nc" id="L290">                localSessionsEnabled = parseBoolean(key, value);</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">            } else if (key.equals(&quot;localSessionsUpgradingEnabled&quot;)) {</span>
<span class="nc" id="L292">                localSessionsUpgradingEnabled = parseBoolean(key, value);</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">            } else if (key.equals(&quot;clientPortAddress&quot;)) {</span>
<span class="nc" id="L294">                clientPortAddress = value.trim();</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">            } else if (key.equals(&quot;secureClientPort&quot;)) {</span>
<span class="nc" id="L296">                secureClientPort = Integer.parseInt(value);</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">            } else if (key.equals(&quot;secureClientPortAddress&quot;)) {</span>
<span class="nc" id="L298">                secureClientPortAddress = value.trim();</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">            } else if (key.equals(&quot;observerMasterPort&quot;)) {</span>
<span class="nc" id="L300">                observerMasterPort = Integer.parseInt(value);</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">            } else if (key.equals(&quot;clientPortListenBacklog&quot;)) {</span>
<span class="nc" id="L302">                clientPortListenBacklog = Integer.parseInt(value);</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">            } else if (key.equals(&quot;tickTime&quot;)) {</span>
<span class="nc" id="L304">                tickTime = Integer.parseInt(value);</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">            } else if (key.equals(&quot;maxClientCnxns&quot;)) {</span>
<span class="nc" id="L306">                maxClientCnxns = Integer.parseInt(value);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">            } else if (key.equals(&quot;minSessionTimeout&quot;)) {</span>
<span class="nc" id="L308">                minSessionTimeout = Integer.parseInt(value);</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">            } else if (key.equals(&quot;maxSessionTimeout&quot;)) {</span>
<span class="nc" id="L310">                maxSessionTimeout = Integer.parseInt(value);</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">            } else if (key.equals(&quot;initLimit&quot;)) {</span>
<span class="nc" id="L312">                initLimit = Integer.parseInt(value);</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">            } else if (key.equals(&quot;syncLimit&quot;)) {</span>
<span class="nc" id="L314">                syncLimit = Integer.parseInt(value);</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">            } else if (key.equals(&quot;connectToLearnerMasterLimit&quot;)) {</span>
<span class="nc" id="L316">                connectToLearnerMasterLimit = Integer.parseInt(value);</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">            } else if (key.equals(&quot;electionAlg&quot;)) {</span>
<span class="nc" id="L318">                electionAlg = Integer.parseInt(value);</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">                if (electionAlg != 3) {</span>
<span class="nc" id="L320">                    throw new ConfigException(&quot;Invalid electionAlg value. Only 3 is supported.&quot;);</span>
                }
<span class="nc bnc" id="L322" title="All 2 branches missed.">            } else if (key.equals(&quot;quorumListenOnAllIPs&quot;)) {</span>
<span class="nc" id="L323">                quorumListenOnAllIPs = parseBoolean(key, value);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">            } else if (key.equals(&quot;peerType&quot;)) {</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">                if (value.toLowerCase().equals(&quot;observer&quot;)) {</span>
<span class="nc" id="L326">                    peerType = LearnerType.OBSERVER;</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">                } else if (value.toLowerCase().equals(&quot;participant&quot;)) {</span>
<span class="nc" id="L328">                    peerType = LearnerType.PARTICIPANT;</span>
                } else {
<span class="nc" id="L330">                    throw new ConfigException(&quot;Unrecognised peertype: &quot; + value);</span>
                }
<span class="nc bnc" id="L332" title="All 2 branches missed.">            } else if (key.equals(&quot;syncEnabled&quot;)) {</span>
<span class="nc" id="L333">                syncEnabled = parseBoolean(key, value);</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">            } else if (key.equals(&quot;dynamicConfigFile&quot;)) {</span>
<span class="nc" id="L335">                dynamicConfigFileStr = value;</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">            } else if (key.equals(&quot;autopurge.snapRetainCount&quot;)) {</span>
<span class="nc" id="L337">                snapRetainCount = Integer.parseInt(value);</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">            } else if (key.equals(&quot;autopurge.purgeInterval&quot;)) {</span>
<span class="nc" id="L339">                purgeInterval = Integer.parseInt(value);</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">            } else if (key.equals(&quot;standaloneEnabled&quot;)) {</span>
<span class="nc" id="L341">                setStandaloneEnabled(parseBoolean(key, value));</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">            } else if (key.equals(&quot;reconfigEnabled&quot;)) {</span>
<span class="nc" id="L343">                setReconfigEnabled(parseBoolean(key, value));</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">            } else if (key.equals(&quot;sslQuorum&quot;)) {</span>
<span class="nc" id="L345">                sslQuorum = parseBoolean(key, value);</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">            } else if (key.equals(&quot;portUnification&quot;)) {</span>
<span class="nc" id="L347">                shouldUsePortUnification = parseBoolean(key, value);</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">            } else if (key.equals(&quot;sslQuorumReloadCertFiles&quot;)) {</span>
<span class="nc" id="L349">                sslQuorumReloadCertFiles = parseBoolean(key, value);</span>
<span class="nc bnc" id="L350" title="All 6 branches missed.">            } else if ((key.startsWith(&quot;server.&quot;) || key.startsWith(&quot;group&quot;) || key.startsWith(&quot;weight&quot;))</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">                       &amp;&amp; zkProp.containsKey(&quot;dynamicConfigFile&quot;)) {</span>
<span class="nc" id="L352">                throw new ConfigException(&quot;parameter: &quot; + key + &quot; must be in a separate dynamic config file&quot;);</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">            } else if (key.equals(QuorumAuth.QUORUM_SASL_AUTH_ENABLED)) {</span>
<span class="nc" id="L354">                quorumEnableSasl = parseBoolean(key, value);</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">            } else if (key.equals(QuorumAuth.QUORUM_SERVER_SASL_AUTH_REQUIRED)) {</span>
<span class="nc" id="L356">                quorumServerRequireSasl = parseBoolean(key, value);</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">            } else if (key.equals(QuorumAuth.QUORUM_LEARNER_SASL_AUTH_REQUIRED)) {</span>
<span class="nc" id="L358">                quorumLearnerRequireSasl = parseBoolean(key, value);</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">            } else if (key.equals(QuorumAuth.QUORUM_LEARNER_SASL_LOGIN_CONTEXT)) {</span>
<span class="nc" id="L360">                quorumLearnerLoginContext = value;</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">            } else if (key.equals(QuorumAuth.QUORUM_SERVER_SASL_LOGIN_CONTEXT)) {</span>
<span class="nc" id="L362">                quorumServerLoginContext = value;</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">            } else if (key.equals(QuorumAuth.QUORUM_KERBEROS_SERVICE_PRINCIPAL)) {</span>
<span class="nc" id="L364">                quorumServicePrincipal = value;</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">            } else if (key.equals(&quot;quorum.cnxn.threads.size&quot;)) {</span>
<span class="nc" id="L366">                quorumCnxnThreadsSize = Integer.parseInt(value);</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">            } else if (key.equals(JvmPauseMonitor.INFO_THRESHOLD_KEY)) {</span>
<span class="nc" id="L368">                jvmPauseInfoThresholdMs = Long.parseLong(value);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">            } else if (key.equals(JvmPauseMonitor.WARN_THRESHOLD_KEY)) {</span>
<span class="nc" id="L370">                jvmPauseWarnThresholdMs = Long.parseLong(value);</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">            } else if (key.equals(JvmPauseMonitor.SLEEP_TIME_MS_KEY)) {</span>
<span class="nc" id="L372">                jvmPauseSleepTimeMs = Long.parseLong(value);</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">            } else if (key.equals(JvmPauseMonitor.JVM_PAUSE_MONITOR_FEATURE_SWITCH_KEY)) {</span>
<span class="nc" id="L374">                jvmPauseMonitorToRun = parseBoolean(key, value);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">            } else if (key.equals(&quot;metricsProvider.className&quot;)) {</span>
<span class="nc" id="L376">                metricsProviderClassName = value;</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">            } else if (key.startsWith(&quot;metricsProvider.&quot;)) {</span>
<span class="nc" id="L378">                String keyForMetricsProvider = key.substring(16);</span>
<span class="nc" id="L379">                metricsProviderConfiguration.put(keyForMetricsProvider, value);</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">            } else if (key.equals(&quot;multiAddress.enabled&quot;)) {</span>
<span class="nc" id="L381">                multiAddressEnabled = parseBoolean(key, value);</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">            } else if (key.equals(&quot;multiAddress.reachabilityCheckTimeoutMs&quot;)) {</span>
<span class="nc" id="L383">                multiAddressReachabilityCheckTimeoutMs = Integer.parseInt(value);</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">            } else if (key.equals(&quot;multiAddress.reachabilityCheckEnabled&quot;)) {</span>
<span class="nc" id="L385">                multiAddressReachabilityCheckEnabled = parseBoolean(key, value);</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">            } else if (key.equals(&quot;oraclePath&quot;)) {</span>
<span class="nc" id="L387">                oraclePath = value;</span>
            } else {
<span class="nc" id="L389">                System.setProperty(&quot;zookeeper.&quot; + key, value);</span>
            }
<span class="nc" id="L391">        }</span>

<span class="nc bnc" id="L393" title="All 4 branches missed.">        if (!quorumEnableSasl &amp;&amp; quorumServerRequireSasl) {</span>
<span class="nc" id="L394">            throw new IllegalArgumentException(QuorumAuth.QUORUM_SASL_AUTH_ENABLED</span>
                                               + &quot; is disabled, so cannot enable &quot;
                                               + QuorumAuth.QUORUM_SERVER_SASL_AUTH_REQUIRED);
        }
<span class="nc bnc" id="L398" title="All 4 branches missed.">        if (!quorumEnableSasl &amp;&amp; quorumLearnerRequireSasl) {</span>
<span class="nc" id="L399">            throw new IllegalArgumentException(QuorumAuth.QUORUM_SASL_AUTH_ENABLED</span>
                                               + &quot; is disabled, so cannot enable &quot;
                                               + QuorumAuth.QUORUM_LEARNER_SASL_AUTH_REQUIRED);
        }
        // If quorumpeer learner is not auth enabled then self won't be able to
        // join quorum. So this condition is ensuring that the quorumpeer learner
        // is also auth enabled while enabling quorum server require sasl.
<span class="nc bnc" id="L406" title="All 4 branches missed.">        if (!quorumLearnerRequireSasl &amp;&amp; quorumServerRequireSasl) {</span>
<span class="nc" id="L407">            throw new IllegalArgumentException(QuorumAuth.QUORUM_LEARNER_SASL_AUTH_REQUIRED</span>
                                               + &quot; is disabled, so cannot enable &quot;
                                               + QuorumAuth.QUORUM_SERVER_SASL_AUTH_REQUIRED);
        }

        // Reset to MIN_SNAP_RETAIN_COUNT if invalid (less than 3)
        // PurgeTxnLog.purge(File, File, int) will not allow to purge less
        // than 3.
<span class="nc bnc" id="L415" title="All 2 branches missed.">        if (snapRetainCount &lt; MIN_SNAP_RETAIN_COUNT) {</span>
<span class="nc" id="L416">            LOG.warn(&quot;Invalid autopurge.snapRetainCount: &quot;</span>
                     + snapRetainCount
                     + &quot;. Defaulting to &quot;
                     + MIN_SNAP_RETAIN_COUNT);
<span class="nc" id="L420">            snapRetainCount = MIN_SNAP_RETAIN_COUNT;</span>
        }

<span class="nc bnc" id="L423" title="All 2 branches missed.">        if (dataDir == null) {</span>
<span class="nc" id="L424">            throw new IllegalArgumentException(&quot;dataDir is not set&quot;);</span>
        }
<span class="nc bnc" id="L426" title="All 2 branches missed.">        if (dataLogDir == null) {</span>
<span class="nc" id="L427">            dataLogDir = dataDir;</span>
        }

<span class="nc bnc" id="L430" title="All 2 branches missed.">        if (clientPort == 0) {</span>
<span class="nc" id="L431">            LOG.info(&quot;clientPort is not set&quot;);</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">            if (clientPortAddress != null) {</span>
<span class="nc" id="L433">                throw new IllegalArgumentException(&quot;clientPortAddress is set but clientPort is not set&quot;);</span>
            }
<span class="nc bnc" id="L435" title="All 2 branches missed.">        } else if (clientPortAddress != null) {</span>
<span class="nc" id="L436">            this.clientPortAddress = new InetSocketAddress(InetAddress.getByName(clientPortAddress), clientPort);</span>
<span class="nc" id="L437">            LOG.info(&quot;clientPortAddress is {}&quot;, formatInetAddr(this.clientPortAddress));</span>
        } else {
<span class="nc" id="L439">            this.clientPortAddress = new InetSocketAddress(clientPort);</span>
<span class="nc" id="L440">            LOG.info(&quot;clientPortAddress is {}&quot;, formatInetAddr(this.clientPortAddress));</span>
        }

<span class="nc bnc" id="L443" title="All 2 branches missed.">        if (secureClientPort == 0) {</span>
<span class="nc" id="L444">            LOG.info(&quot;secureClientPort is not set&quot;);</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">            if (secureClientPortAddress != null) {</span>
<span class="nc" id="L446">                throw new IllegalArgumentException(&quot;secureClientPortAddress is set but secureClientPort is not set&quot;);</span>
            }
<span class="nc bnc" id="L448" title="All 2 branches missed.">        } else if (secureClientPortAddress != null) {</span>
<span class="nc" id="L449">            this.secureClientPortAddress = new InetSocketAddress(InetAddress.getByName(secureClientPortAddress), secureClientPort);</span>
<span class="nc" id="L450">            LOG.info(&quot;secureClientPortAddress is {}&quot;, formatInetAddr(this.secureClientPortAddress));</span>
        } else {
<span class="nc" id="L452">            this.secureClientPortAddress = new InetSocketAddress(secureClientPort);</span>
<span class="nc" id="L453">            LOG.info(&quot;secureClientPortAddress is {}&quot;, formatInetAddr(this.secureClientPortAddress));</span>
        }
<span class="nc bnc" id="L455" title="All 2 branches missed.">        if (this.secureClientPortAddress != null) {</span>
<span class="nc" id="L456">            configureSSLAuth();</span>
        }

<span class="nc bnc" id="L459" title="All 2 branches missed.">        if (observerMasterPort &lt;= 0) {</span>
<span class="nc" id="L460">            LOG.info(&quot;observerMasterPort is not set&quot;);</span>
        } else {
<span class="nc" id="L462">            this.observerMasterPort = observerMasterPort;</span>
<span class="nc" id="L463">            LOG.info(&quot;observerMasterPort is {}&quot;, observerMasterPort);</span>
        }

<span class="nc bnc" id="L466" title="All 2 branches missed.">        if (tickTime == 0) {</span>
<span class="nc" id="L467">            throw new IllegalArgumentException(&quot;tickTime is not set&quot;);</span>
        }

<span class="nc bnc" id="L470" title="All 2 branches missed.">        minSessionTimeout = minSessionTimeout == -1 ? tickTime * 2 : minSessionTimeout;</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">        maxSessionTimeout = maxSessionTimeout == -1 ? tickTime * 20 : maxSessionTimeout;</span>

<span class="nc bnc" id="L473" title="All 2 branches missed.">        if (minSessionTimeout &gt; maxSessionTimeout) {</span>
<span class="nc" id="L474">            throw new IllegalArgumentException(&quot;minSessionTimeout must not be larger than maxSessionTimeout&quot;);</span>
        }

<span class="nc" id="L477">        LOG.info(&quot;metricsProvider.className is {}&quot;, metricsProviderClassName);</span>
        try {
<span class="nc" id="L479">            Class.forName(metricsProviderClassName, false, Thread.currentThread().getContextClassLoader());</span>
<span class="nc" id="L480">        } catch (ClassNotFoundException error) {</span>
<span class="nc" id="L481">            throw new IllegalArgumentException(&quot;metrics provider class was not found&quot;, error);</span>
<span class="nc" id="L482">        }</span>

        // backward compatibility - dynamic configuration in the same file as
        // static configuration params see writeDynamicConfig()
<span class="nc bnc" id="L486" title="All 2 branches missed.">        if (dynamicConfigFileStr == null) {</span>
<span class="nc" id="L487">            setupQuorumPeerConfig(zkProp, true);</span>
<span class="nc bnc" id="L488" title="All 4 branches missed.">            if (isDistributed() &amp;&amp; isReconfigEnabled()) {</span>
                // we don't backup static config for standalone mode.
                // we also don't backup if reconfig feature is disabled.
<span class="nc" id="L491">                backupOldConfig();</span>
            }
        }
<span class="nc" id="L494">    }</span>

    /**
     * Configure SSL authentication only if it is not configured.
     *
     * @throws ConfigException
     *             If authentication scheme is configured but authentication
     *             provider is not configured.
     */
    public static void configureSSLAuth() throws ConfigException {
<span class="nc" id="L504">        try (ClientX509Util clientX509Util = new ClientX509Util()) {</span>
<span class="nc" id="L505">            String sslAuthProp = ProviderRegistry.AUTHPROVIDER_PROPERTY_PREFIX</span>
<span class="nc" id="L506">                                 + System.getProperty(clientX509Util.getSslAuthProviderProperty(), &quot;x509&quot;);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">            if (System.getProperty(sslAuthProp) == null) {</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">                if ((ProviderRegistry.AUTHPROVIDER_PROPERTY_PREFIX + &quot;x509&quot;).equals(sslAuthProp)) {</span>
<span class="nc" id="L509">                    System.setProperty(ProviderRegistry.AUTHPROVIDER_PROPERTY_PREFIX + &quot;x509&quot;,</span>
                        &quot;org.apache.zookeeper.server.auth.X509AuthenticationProvider&quot;);
                } else {
<span class="nc" id="L512">                    throw new ConfigException(&quot;No auth provider configured for the SSL authentication scheme '&quot;</span>
<span class="nc" id="L513">                                              + System.getProperty(clientX509Util.getSslAuthProviderProperty())</span>
                                              + &quot;'.&quot;);
                }
            }
        }
<span class="nc" id="L518">    }</span>

    /**
     * Backward compatibility -- It would backup static config file on bootup
     * if users write dynamic configuration in &quot;zoo.cfg&quot;.
     */
    private void backupOldConfig() throws IOException {
<span class="nc" id="L525">        new AtomicFileWritingIdiom(new File(configFileStr + &quot;.bak&quot;), new OutputStreamStatement() {</span>
            @Override
            public void write(OutputStream output) throws IOException {
<span class="nc" id="L528">                try (InputStream input = new FileInputStream(new File(configFileStr))) {</span>
<span class="nc" id="L529">                    byte[] buf = new byte[1024];</span>
                    int bytesRead;
<span class="nc bnc" id="L531" title="All 2 branches missed.">                    while ((bytesRead = input.read(buf)) &gt; 0) {</span>
<span class="nc" id="L532">                        output.write(buf, 0, bytesRead);</span>
                    }
                }
<span class="nc" id="L535">            }</span>
        });
<span class="nc" id="L537">    }</span>

    /**
     * Writes dynamic configuration file
     */
    public static void writeDynamicConfig(final String dynamicConfigFilename, final QuorumVerifier qv, final boolean needKeepVersion) throws IOException {

<span class="nc" id="L544">        new AtomicFileWritingIdiom(new File(dynamicConfigFilename), new WriterStatement() {</span>
            @Override
            public void write(Writer out) throws IOException {
<span class="nc" id="L547">                Properties cfg = new Properties();</span>
<span class="nc" id="L548">                cfg.load(new StringReader(qv.toString()));</span>

<span class="nc" id="L550">                List&lt;String&gt; servers = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">                for (Entry&lt;Object, Object&gt; entry : cfg.entrySet()) {</span>
<span class="nc" id="L552">                    String key = entry.getKey().toString().trim();</span>
<span class="nc bnc" id="L553" title="All 4 branches missed.">                    if (!needKeepVersion &amp;&amp; key.startsWith(&quot;version&quot;)) {</span>
<span class="nc" id="L554">                        continue;</span>
                    }

<span class="nc" id="L557">                    String value = entry.getValue().toString().trim();</span>
<span class="nc" id="L558">                    servers.add(key.concat(&quot;=&quot;).concat(value));</span>
<span class="nc" id="L559">                }</span>

<span class="nc" id="L561">                Collections.sort(servers);</span>
<span class="nc" id="L562">                out.write(StringUtils.joinStrings(servers, &quot;\n&quot;));</span>
<span class="nc" id="L563">            }</span>
        });
<span class="nc" id="L565">    }</span>

    /**
     * Edit static config file.
     * If there are quorum information in static file, e.g. &quot;server.X&quot;, &quot;group&quot;,
     * it will remove them.
     * If it needs to erase client port information left by the old config,
     * &quot;eraseClientPortAddress&quot; should be set true.
     * It should also updates dynamic file pointer on reconfig.
     */
    public static void editStaticConfig(final String configFileStr, final String dynamicFileStr, final boolean eraseClientPortAddress) throws IOException {
        // Some tests may not have a static config file.
<span class="nc bnc" id="L577" title="All 2 branches missed.">        if (configFileStr == null) {</span>
<span class="nc" id="L578">            return;</span>
        }

<span class="nc" id="L581">        File configFile = (new VerifyingFileFactory.Builder(LOG).warnForRelativePath().failForNonExistingPath().build())</span>
<span class="nc" id="L582">            .create(configFileStr);</span>

<span class="nc" id="L584">        final File dynamicFile = (new VerifyingFileFactory.Builder(LOG)</span>
<span class="nc" id="L585">            .warnForRelativePath()</span>
<span class="nc" id="L586">            .failForNonExistingPath()</span>
<span class="nc" id="L587">            .build()).create(dynamicFileStr);</span>

<span class="nc" id="L589">        final Properties cfg = new Properties();</span>
<span class="nc" id="L590">        try (FileInputStream in = new FileInputStream(configFile)) {</span>
<span class="nc" id="L591">            cfg.load(in);</span>
        }

<span class="nc" id="L594">        new AtomicFileWritingIdiom(new File(configFileStr), new WriterStatement() {</span>
            @Override
            public void write(Writer out) throws IOException {
<span class="nc bnc" id="L597" title="All 2 branches missed.">                for (Entry&lt;Object, Object&gt; entry : cfg.entrySet()) {</span>
<span class="nc" id="L598">                    String key = entry.getKey().toString().trim();</span>

<span class="nc bnc" id="L600" title="All 2 branches missed.">                    if (key.startsWith(&quot;server.&quot;)</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">                        || key.startsWith(&quot;group&quot;)</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">                        || key.startsWith(&quot;weight&quot;)</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">                        || key.startsWith(&quot;dynamicConfigFile&quot;)</span>
<span class="nc bnc" id="L604" title="All 4 branches missed.">                        || key.startsWith(&quot;peerType&quot;)</span>
                        || (eraseClientPortAddress
<span class="nc bnc" id="L606" title="All 2 branches missed.">                            &amp;&amp; (key.startsWith(&quot;clientPort&quot;)</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">                                || key.startsWith(&quot;clientPortAddress&quot;)))) {</span>
                        // not writing them back to static file
<span class="nc" id="L609">                        continue;</span>
                    }

<span class="nc" id="L612">                    String value = entry.getValue().toString().trim();</span>
<span class="nc" id="L613">                    out.write(key.concat(&quot;=&quot;).concat(value).concat(&quot;\n&quot;));</span>
<span class="nc" id="L614">                }</span>

                // updates the dynamic file pointer
<span class="nc" id="L617">                String dynamicConfigFilePath = PathUtils.normalizeFileSystemPath(dynamicFile.getCanonicalPath());</span>
<span class="nc" id="L618">                out.write(&quot;dynamicConfigFile=&quot;.concat(dynamicConfigFilePath).concat(&quot;\n&quot;));</span>
<span class="nc" id="L619">            }</span>
        });
<span class="nc" id="L621">    }</span>

    public static void deleteFile(String filename) {
<span class="nc bnc" id="L624" title="All 2 branches missed.">        if (filename == null) {</span>
<span class="nc" id="L625">            return;</span>
        }
<span class="nc" id="L627">        File f = new File(filename);</span>
<span class="nc bnc" id="L628" title="All 2 branches missed.">        if (f.exists()) {</span>
            try {
<span class="nc" id="L630">                f.delete();</span>
<span class="nc" id="L631">            } catch (Exception e) {</span>
<span class="nc" id="L632">                LOG.warn(&quot;deleting {} failed&quot;, filename);</span>
<span class="nc" id="L633">            }</span>
        }
<span class="nc" id="L635">    }</span>


    private static QuorumVerifier createQuorumVerifier(Properties dynamicConfigProp, boolean isHierarchical, String oraclePath) throws ConfigException {
<span class="nc bnc" id="L639" title="All 2 branches missed.">        if (oraclePath == null) {</span>
<span class="nc" id="L640">            return createQuorumVerifier(dynamicConfigProp, isHierarchical);</span>
        } else {
<span class="nc" id="L642">            return new QuorumOracleMaj(dynamicConfigProp, oraclePath);</span>
        }
    }

    private static QuorumVerifier createQuorumVerifier(Properties dynamicConfigProp, boolean isHierarchical) throws ConfigException {
<span class="nc bnc" id="L647" title="All 2 branches missed.">        if (isHierarchical) {</span>
<span class="nc" id="L648">            return new QuorumHierarchical(dynamicConfigProp);</span>
        } else {
            /*
             * The default QuorumVerifier is QuorumMaj
             */
            //LOG.info(&quot;Defaulting to majority quorums&quot;);
<span class="nc" id="L654">            return new QuorumMaj(dynamicConfigProp);</span>
        }
    }

    void setupQuorumPeerConfig(Properties prop, boolean configBackwardCompatibilityMode) throws IOException, ConfigException {
<span class="nc" id="L659">        quorumVerifier = parseDynamicConfig(prop, electionAlg, true, configBackwardCompatibilityMode, oraclePath);</span>
<span class="nc" id="L660">        setupMyId();</span>
<span class="nc" id="L661">        setupClientPort();</span>
<span class="nc" id="L662">        setupPeerType();</span>
<span class="nc" id="L663">        checkValidity();</span>
<span class="nc" id="L664">    }</span>

    /**
     * Parse dynamic configuration file and return
     * quorumVerifier for new configuration.
     * @param dynamicConfigProp Properties to parse from.
     * @throws IOException
     * @throws ConfigException
     */
    public static QuorumVerifier parseDynamicConfig(Properties dynamicConfigProp, int eAlg, boolean warnings, boolean configBackwardCompatibilityMode, String oraclePath) throws IOException, ConfigException {
<span class="nc" id="L674">        boolean isHierarchical = false;</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">        for (Entry&lt;Object, Object&gt; entry : dynamicConfigProp.entrySet()) {</span>
<span class="nc" id="L676">            String key = entry.getKey().toString().trim();</span>
<span class="nc bnc" id="L677" title="All 4 branches missed.">            if (key.startsWith(&quot;group&quot;) || key.startsWith(&quot;weight&quot;)) {</span>
<span class="nc" id="L678">                isHierarchical = true;</span>
<span class="nc bnc" id="L679" title="All 6 branches missed.">            } else if (!configBackwardCompatibilityMode &amp;&amp; !key.startsWith(&quot;server.&quot;) &amp;&amp; !key.equals(&quot;version&quot;)) {</span>
<span class="nc" id="L680">                LOG.info(dynamicConfigProp.toString());</span>
<span class="nc" id="L681">                throw new ConfigException(&quot;Unrecognised parameter: &quot; + key);</span>
            }
<span class="nc" id="L683">        }</span>

<span class="nc" id="L685">        QuorumVerifier qv = createQuorumVerifier(dynamicConfigProp, isHierarchical, oraclePath);</span>

<span class="nc" id="L687">        int numParticipators = qv.getVotingMembers().size();</span>
<span class="nc" id="L688">        int numObservers = qv.getObservingMembers().size();</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">        if (numParticipators == 0) {</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">            if (!standaloneEnabled) {</span>
<span class="nc" id="L691">                throw new IllegalArgumentException(&quot;standaloneEnabled = false then &quot;</span>
                                                   + &quot;number of participants should be &gt;0&quot;);
            }
<span class="nc bnc" id="L694" title="All 2 branches missed.">            if (numObservers &gt; 0) {</span>
<span class="nc" id="L695">                throw new IllegalArgumentException(&quot;Observers w/o participants is an invalid configuration&quot;);</span>
            }
<span class="nc bnc" id="L697" title="All 4 branches missed.">        } else if (numParticipators == 1 &amp;&amp; standaloneEnabled) {</span>
            // HBase currently adds a single server line to the config, for
            // b/w compatibility reasons we need to keep this here. If standaloneEnabled
            // is true, the QuorumPeerMain script will create a standalone server instead
            // of a quorum configuration
<span class="nc" id="L702">            LOG.error(&quot;Invalid configuration, only one server specified (ignoring)&quot;);</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">            if (numObservers &gt; 0) {</span>
<span class="nc" id="L704">                throw new IllegalArgumentException(&quot;Observers w/o quorum is an invalid configuration&quot;);</span>
            }
        } else {
<span class="nc bnc" id="L707" title="All 2 branches missed.">            if (warnings) {</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">                if (numParticipators &lt;= 2) {</span>
<span class="nc" id="L709">                    LOG.warn(&quot;No server failure will be tolerated. You need at least 3 servers.&quot;);</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">                } else if (numParticipators % 2 == 0) {</span>
<span class="nc" id="L711">                    LOG.warn(&quot;Non-optimal configuration, consider an odd number of servers.&quot;);</span>
                }
            }

<span class="nc bnc" id="L715" title="All 2 branches missed.">            for (QuorumServer s : qv.getVotingMembers().values()) {</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">                if (s.electionAddr == null) {</span>
<span class="nc" id="L717">                    throw new IllegalArgumentException(&quot;Missing election port for server: &quot; + s.id);</span>
                }
<span class="nc" id="L719">            }</span>
        }
<span class="nc" id="L721">        return qv;</span>
    }

    private void setupMyId() throws IOException {
<span class="nc" id="L725">        File myIdFile = new File(dataDir, &quot;myid&quot;);</span>
        // standalone server doesn't need myid file.
<span class="nc bnc" id="L727" title="All 2 branches missed.">        if (!myIdFile.isFile()) {</span>
<span class="nc" id="L728">            return;</span>
        }
<span class="nc" id="L730">        BufferedReader br = new BufferedReader(new FileReader(myIdFile));</span>
        String myIdString;
        try {
<span class="nc" id="L733">            myIdString = br.readLine();</span>
        } finally {
<span class="nc" id="L735">            br.close();</span>
        }
        try {
<span class="nc" id="L738">            serverId = Long.parseLong(myIdString);</span>
<span class="nc" id="L739">            MDC.put(&quot;myid&quot;, myIdString);</span>
<span class="nc" id="L740">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L741">            throw new IllegalArgumentException(&quot;serverid &quot; + myIdString + &quot; is not a number&quot;);</span>
<span class="nc" id="L742">        }</span>
<span class="nc" id="L743">    }</span>

    private void setupClientPort() throws ConfigException {
<span class="nc bnc" id="L746" title="All 2 branches missed.">        if (serverId == UNSET_SERVERID) {</span>
<span class="nc" id="L747">            return;</span>
        }
<span class="nc" id="L749">        QuorumServer qs = quorumVerifier.getAllMembers().get(serverId);</span>
<span class="nc bnc" id="L750" title="All 6 branches missed.">        if (clientPortAddress != null &amp;&amp; qs != null &amp;&amp; qs.clientAddr != null) {</span>
<span class="nc bnc" id="L751" title="All 4 branches missed.">            if ((!clientPortAddress.getAddress().isAnyLocalAddress() &amp;&amp; !clientPortAddress.equals(qs.clientAddr)) || (</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">                clientPortAddress.getAddress().isAnyLocalAddress()</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">                &amp;&amp; clientPortAddress.getPort() != qs.clientAddr.getPort())) {</span>
<span class="nc" id="L754">                throw new ConfigException(&quot;client address for this server (id = &quot; + serverId</span>
                                          + &quot;) in static config file is &quot; + clientPortAddress
                                          + &quot; is different from client address found in dynamic file: &quot; + qs.clientAddr);
            }
        }
<span class="nc bnc" id="L759" title="All 4 branches missed.">        if (qs != null &amp;&amp; qs.clientAddr != null) {</span>
<span class="nc" id="L760">            clientPortAddress = qs.clientAddr;</span>
        }
<span class="nc bnc" id="L762" title="All 4 branches missed.">        if (qs != null &amp;&amp; qs.clientAddr == null) {</span>
<span class="nc" id="L763">            qs.clientAddr = clientPortAddress;</span>
<span class="nc" id="L764">            qs.isClientAddrFromStatic = true;</span>
        }
<span class="nc" id="L766">    }</span>

    private void setupPeerType() {
        // Warn about inconsistent peer type
<span class="nc bnc" id="L770" title="All 2 branches missed.">        LearnerType roleByServersList = quorumVerifier.getObservingMembers().containsKey(serverId)</span>
<span class="nc" id="L771">            ? LearnerType.OBSERVER</span>
<span class="nc" id="L772">            : LearnerType.PARTICIPANT;</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">        if (roleByServersList != peerType) {</span>
<span class="nc" id="L774">            LOG.warn(</span>
                &quot;Peer type from servers list ({}) doesn't match peerType ({}). Defaulting to servers list.&quot;,
                roleByServersList,
                peerType);

<span class="nc" id="L779">            peerType = roleByServersList;</span>
        }
<span class="nc" id="L781">    }</span>

    public void checkValidity() throws IOException, ConfigException {
<span class="nc bnc" id="L784" title="All 2 branches missed.">        if (isDistributed()) {</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">            if (initLimit == 0) {</span>
<span class="nc" id="L786">                throw new IllegalArgumentException(&quot;initLimit is not set&quot;);</span>
            }
<span class="nc bnc" id="L788" title="All 2 branches missed.">            if (syncLimit == 0) {</span>
<span class="nc" id="L789">                throw new IllegalArgumentException(&quot;syncLimit is not set&quot;);</span>
            }
<span class="nc bnc" id="L791" title="All 2 branches missed.">            if (serverId == UNSET_SERVERID) {</span>
<span class="nc" id="L792">                throw new IllegalArgumentException(&quot;myid file is missing&quot;);</span>
            }
        }
<span class="nc" id="L795">    }</span>

    public InetSocketAddress getClientPortAddress() {
<span class="nc" id="L798">        return clientPortAddress;</span>
    }
    public InetSocketAddress getSecureClientPortAddress() {
<span class="nc" id="L801">        return secureClientPortAddress;</span>
    }
    public int getObserverMasterPort() {
<span class="nc" id="L804">        return observerMasterPort;</span>
    }
    public File getDataDir() {
<span class="nc" id="L807">        return dataDir;</span>
    }
    public File getDataLogDir() {
<span class="nc" id="L810">        return dataLogDir;</span>
    }

    public String getInitialConfig() {
<span class="nc" id="L814">        return initialConfig;</span>
    }

    public int getTickTime() {
<span class="nc" id="L818">        return tickTime;</span>
    }
    public int getMaxClientCnxns() {
<span class="nc" id="L821">        return maxClientCnxns;</span>
    }
    public int getMinSessionTimeout() {
<span class="nc" id="L824">        return minSessionTimeout;</span>
    }
    public int getMaxSessionTimeout() {
<span class="nc" id="L827">        return maxSessionTimeout;</span>
    }
    public String getMetricsProviderClassName() {
<span class="nc" id="L830">        return metricsProviderClassName;</span>
    }
    public Properties getMetricsProviderConfiguration() {
<span class="nc" id="L833">        return metricsProviderConfiguration;</span>
    }
    public boolean areLocalSessionsEnabled() {
<span class="nc" id="L836">        return localSessionsEnabled;</span>
    }
    public boolean isLocalSessionsUpgradingEnabled() {
<span class="nc" id="L839">        return localSessionsUpgradingEnabled;</span>
    }
    public boolean isSslQuorum() {
<span class="nc" id="L842">        return sslQuorum;</span>
    }

    public boolean shouldUsePortUnification() {
<span class="nc" id="L846">        return shouldUsePortUnification;</span>
    }
    public int getClientPortListenBacklog() {
<span class="nc" id="L849">        return clientPortListenBacklog;</span>
    }

    public int getInitLimit() {
<span class="nc" id="L853">        return initLimit;</span>
    }
    public int getSyncLimit() {
<span class="nc" id="L856">        return syncLimit;</span>
    }
    public int getConnectToLearnerMasterLimit() {
<span class="nc" id="L859">        return connectToLearnerMasterLimit;</span>
    }
    public int getElectionAlg() {
<span class="nc" id="L862">        return electionAlg;</span>
    }
    public int getElectionPort() {
<span class="nc" id="L865">        return electionPort;</span>
    }

    public int getSnapRetainCount() {
<span class="nc" id="L869">        return snapRetainCount;</span>
    }

    public int getPurgeInterval() {
<span class="nc" id="L873">        return purgeInterval;</span>
    }

    public boolean getSyncEnabled() {
<span class="nc" id="L877">        return syncEnabled;</span>
    }

    public QuorumVerifier getQuorumVerifier() {
<span class="nc" id="L881">        return quorumVerifier;</span>
    }

    public QuorumVerifier getLastSeenQuorumVerifier() {
<span class="nc" id="L885">        return lastSeenQuorumVerifier;</span>
    }

    public Map&lt;Long, QuorumServer&gt; getServers() {
        // returns all configuration servers -- participants and observers
<span class="nc" id="L890">        return Collections.unmodifiableMap(quorumVerifier.getAllMembers());</span>
    }

    public long getJvmPauseInfoThresholdMs() {
<span class="nc" id="L894">        return jvmPauseInfoThresholdMs;</span>
    }
    public long getJvmPauseWarnThresholdMs() {
<span class="nc" id="L897">        return jvmPauseWarnThresholdMs;</span>
    }
    public long getJvmPauseSleepTimeMs() {
<span class="nc" id="L900">        return jvmPauseSleepTimeMs;</span>
    }
    public boolean isJvmPauseMonitorToRun() {
<span class="nc" id="L903">        return jvmPauseMonitorToRun;</span>
    }

    public long getServerId() {
<span class="nc" id="L907">        return serverId;</span>
    }

    public boolean isDistributed() {
<span class="nc bnc" id="L911" title="All 6 branches missed.">        return quorumVerifier != null &amp;&amp; (!standaloneEnabled || quorumVerifier.getVotingMembers().size() &gt; 1);</span>
    }

    public LearnerType getPeerType() {
<span class="nc" id="L915">        return peerType;</span>
    }

    public String getConfigFilename() {
<span class="nc" id="L919">        return configFileStr;</span>
    }

    public Boolean getQuorumListenOnAllIPs() {
<span class="nc" id="L923">        return quorumListenOnAllIPs;</span>
    }

    public boolean isMultiAddressEnabled() {
<span class="nc" id="L927">        return multiAddressEnabled;</span>
    }

    public boolean isMultiAddressReachabilityCheckEnabled() {
<span class="nc" id="L931">        return multiAddressReachabilityCheckEnabled;</span>
    }

    public int getMultiAddressReachabilityCheckTimeoutMs() {
<span class="nc" id="L935">        return multiAddressReachabilityCheckTimeoutMs;</span>
    }

    public static boolean isStandaloneEnabled() {
<span class="nc" id="L939">        return standaloneEnabled;</span>
    }

    public static void setStandaloneEnabled(boolean enabled) {
<span class="nc" id="L943">        standaloneEnabled = enabled;</span>
<span class="nc" id="L944">    }</span>

    public static boolean isReconfigEnabled() {
<span class="nc" id="L947">        return reconfigEnabled;</span>
    }

    public static void setReconfigEnabled(boolean enabled) {
<span class="nc" id="L951">        reconfigEnabled = enabled;</span>
<span class="nc" id="L952">    }</span>

    private boolean parseBoolean(String key, String value) throws ConfigException {
<span class="nc bnc" id="L955" title="All 2 branches missed.">        if (value.equalsIgnoreCase(&quot;true&quot;)) {</span>
<span class="nc" id="L956">            return true;</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">        } else if (value.equalsIgnoreCase(&quot;false&quot;)) {</span>
<span class="nc" id="L958">            return false;</span>
        } else {
<span class="nc" id="L960">            throw new ConfigException(&quot;Invalid option &quot;</span>
                                      + value
                                      + &quot; for &quot;
                                      + key
                                      + &quot;. Choose 'true' or 'false.'&quot;);
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>