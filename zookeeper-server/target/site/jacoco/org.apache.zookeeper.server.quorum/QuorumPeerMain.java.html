<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QuorumPeerMain.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache ZooKeeper - Server</a> &gt; <a href="index.source.html" class="el_package">org.apache.zookeeper.server.quorum</a> &gt; <span class="el_source">QuorumPeerMain.java</span></div><h1>QuorumPeerMain.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.zookeeper.server.quorum;

import java.io.IOException;
import javax.management.JMException;
import javax.security.sasl.SaslException;
import org.apache.yetus.audience.InterfaceAudience;
import org.apache.zookeeper.audit.ZKAuditProvider;
import org.apache.zookeeper.jmx.ManagedUtil;
import org.apache.zookeeper.metrics.MetricsProvider;
import org.apache.zookeeper.metrics.MetricsProviderLifeCycleException;
import org.apache.zookeeper.metrics.impl.MetricsProviderBootstrap;
import org.apache.zookeeper.server.DatadirCleanupManager;
import org.apache.zookeeper.server.ExitCode;
import org.apache.zookeeper.server.ServerCnxnFactory;
import org.apache.zookeeper.server.ServerMetrics;
import org.apache.zookeeper.server.ZKDatabase;
import org.apache.zookeeper.server.ZooKeeperServerMain;
import org.apache.zookeeper.server.admin.AdminServer.AdminServerException;
import org.apache.zookeeper.server.auth.ProviderRegistry;
import org.apache.zookeeper.server.persistence.FileTxnSnapLog;
import org.apache.zookeeper.server.persistence.FileTxnSnapLog.DatadirException;
import org.apache.zookeeper.server.quorum.QuorumPeerConfig.ConfigException;
import org.apache.zookeeper.server.util.JvmPauseMonitor;
import org.apache.zookeeper.util.ServiceUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 *
 * &lt;h2&gt;Configuration file&lt;/h2&gt;
 *
 * When the main() method of this class is used to start the program, the first
 * argument is used as a path to the config file, which will be used to obtain
 * configuration information. This file is a Properties file, so keys and
 * values are separated by equals (=) and the key/value pairs are separated
 * by new lines. The following is a general summary of keys used in the
 * configuration file. For full details on this see the documentation in
 * docs/index.html
 * &lt;ol&gt;
 * &lt;li&gt;dataDir - The directory where the ZooKeeper data is stored.&lt;/li&gt;
 * &lt;li&gt;dataLogDir - The directory where the ZooKeeper transaction log is stored.&lt;/li&gt;
 * &lt;li&gt;clientPort - The port used to communicate with clients.&lt;/li&gt;
 * &lt;li&gt;tickTime - The duration of a tick in milliseconds. This is the basic
 * unit of time in ZooKeeper.&lt;/li&gt;
 * &lt;li&gt;initLimit - The maximum number of ticks that a follower will wait to
 * initially synchronize with a leader.&lt;/li&gt;
 * &lt;li&gt;syncLimit - The maximum number of ticks that a follower will wait for a
 * message (including heartbeats) from the leader.&lt;/li&gt;
 * &lt;li&gt;server.&lt;i&gt;id&lt;/i&gt; - This is the host:port[:port] that the server with the
 * given id will use for the quorum protocol.&lt;/li&gt;
 * &lt;/ol&gt;
 * In addition to the config file. There is a file in the data directory called
 * &quot;myid&quot; that contains the server id as an ASCII decimal value.
 *
 */
@InterfaceAudience.Public
<span class="nc" id="L75">public class QuorumPeerMain {</span>

<span class="nc" id="L77">    private static final Logger LOG = LoggerFactory.getLogger(QuorumPeerMain.class);</span>

    private static final String USAGE = &quot;Usage: QuorumPeerMain configfile&quot;;

    protected QuorumPeer quorumPeer;

    /**
     * To start the replicated server specify the configuration file name on
     * the command line.
     * @param args path to the configfile
     */
    public static void main(String[] args) {
<span class="nc" id="L89">        QuorumPeerMain main = new QuorumPeerMain();</span>
        try {
<span class="nc" id="L91">            main.initializeAndRun(args);</span>
<span class="nc" id="L92">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L93">            LOG.error(&quot;Invalid arguments, exiting abnormally&quot;, e);</span>
<span class="nc" id="L94">            LOG.info(USAGE);</span>
<span class="nc" id="L95">            System.err.println(USAGE);</span>
<span class="nc" id="L96">            ZKAuditProvider.addServerStartFailureAuditLog();</span>
<span class="nc" id="L97">            ServiceUtils.requestSystemExit(ExitCode.INVALID_INVOCATION.getValue());</span>
<span class="nc" id="L98">        } catch (ConfigException e) {</span>
<span class="nc" id="L99">            LOG.error(&quot;Invalid config, exiting abnormally&quot;, e);</span>
<span class="nc" id="L100">            System.err.println(&quot;Invalid config, exiting abnormally&quot;);</span>
<span class="nc" id="L101">            ZKAuditProvider.addServerStartFailureAuditLog();</span>
<span class="nc" id="L102">            ServiceUtils.requestSystemExit(ExitCode.INVALID_INVOCATION.getValue());</span>
<span class="nc" id="L103">        } catch (DatadirException e) {</span>
<span class="nc" id="L104">            LOG.error(&quot;Unable to access datadir, exiting abnormally&quot;, e);</span>
<span class="nc" id="L105">            System.err.println(&quot;Unable to access datadir, exiting abnormally&quot;);</span>
<span class="nc" id="L106">            ZKAuditProvider.addServerStartFailureAuditLog();</span>
<span class="nc" id="L107">            ServiceUtils.requestSystemExit(ExitCode.UNABLE_TO_ACCESS_DATADIR.getValue());</span>
<span class="nc" id="L108">        } catch (AdminServerException e) {</span>
<span class="nc" id="L109">            LOG.error(&quot;Unable to start AdminServer, exiting abnormally&quot;, e);</span>
<span class="nc" id="L110">            System.err.println(&quot;Unable to start AdminServer, exiting abnormally&quot;);</span>
<span class="nc" id="L111">            ZKAuditProvider.addServerStartFailureAuditLog();</span>
<span class="nc" id="L112">            ServiceUtils.requestSystemExit(ExitCode.ERROR_STARTING_ADMIN_SERVER.getValue());</span>
<span class="nc" id="L113">        } catch (Exception e) {</span>
<span class="nc" id="L114">            LOG.error(&quot;Unexpected exception, exiting abnormally&quot;, e);</span>
<span class="nc" id="L115">            ZKAuditProvider.addServerStartFailureAuditLog();</span>
<span class="nc" id="L116">            ServiceUtils.requestSystemExit(ExitCode.UNEXPECTED_ERROR.getValue());</span>
<span class="nc" id="L117">        }</span>
<span class="nc" id="L118">        LOG.info(&quot;Exiting normally&quot;);</span>
<span class="nc" id="L119">        ServiceUtils.requestSystemExit(ExitCode.EXECUTION_FINISHED.getValue());</span>
<span class="nc" id="L120">    }</span>

    protected void initializeAndRun(String[] args) throws ConfigException, IOException, AdminServerException {
<span class="nc" id="L123">        QuorumPeerConfig config = new QuorumPeerConfig();</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (args.length == 1) {</span>
<span class="nc" id="L125">            config.parse(args[0]);</span>
        }

        // Start and schedule the the purge task
<span class="nc" id="L129">        DatadirCleanupManager purgeMgr = new DatadirCleanupManager(</span>
<span class="nc" id="L130">            config.getDataDir(),</span>
<span class="nc" id="L131">            config.getDataLogDir(),</span>
<span class="nc" id="L132">            config.getSnapRetainCount(),</span>
<span class="nc" id="L133">            config.getPurgeInterval());</span>
<span class="nc" id="L134">        purgeMgr.start();</span>

<span class="nc bnc" id="L136" title="All 4 branches missed.">        if (args.length == 1 &amp;&amp; config.isDistributed()) {</span>
<span class="nc" id="L137">            runFromConfig(config);</span>
        } else {
<span class="nc" id="L139">            LOG.warn(&quot;Either no config or no quorum defined in config, running in standalone mode&quot;);</span>
            // there is only server in the quorum -- run as standalone
<span class="nc" id="L141">            ZooKeeperServerMain.main(args);</span>
        }
<span class="nc" id="L143">    }</span>

    public void runFromConfig(QuorumPeerConfig config) throws IOException, AdminServerException {
        try {
<span class="nc" id="L147">            ManagedUtil.registerLog4jMBeans();</span>
<span class="nc" id="L148">        } catch (JMException e) {</span>
<span class="nc" id="L149">            LOG.warn(&quot;Unable to register log4j JMX control&quot;, e);</span>
<span class="nc" id="L150">        }</span>

<span class="nc" id="L152">        LOG.info(&quot;Starting quorum peer, myid=&quot; + config.getServerId());</span>
        final MetricsProvider metricsProvider;
        try {
<span class="nc" id="L155">            metricsProvider = MetricsProviderBootstrap.startMetricsProvider(</span>
<span class="nc" id="L156">                config.getMetricsProviderClassName(),</span>
<span class="nc" id="L157">                config.getMetricsProviderConfiguration());</span>
<span class="nc" id="L158">        } catch (MetricsProviderLifeCycleException error) {</span>
<span class="nc" id="L159">            throw new IOException(&quot;Cannot boot MetricsProvider &quot; + config.getMetricsProviderClassName(), error);</span>
<span class="nc" id="L160">        }</span>
        try {
<span class="nc" id="L162">            ServerMetrics.metricsProviderInitialized(metricsProvider);</span>
<span class="nc" id="L163">            ProviderRegistry.initialize();</span>
<span class="nc" id="L164">            ServerCnxnFactory cnxnFactory = null;</span>
<span class="nc" id="L165">            ServerCnxnFactory secureCnxnFactory = null;</span>

<span class="nc bnc" id="L167" title="All 2 branches missed.">            if (config.getClientPortAddress() != null) {</span>
<span class="nc" id="L168">                cnxnFactory = ServerCnxnFactory.createFactory();</span>
<span class="nc" id="L169">                cnxnFactory.configure(config.getClientPortAddress(), config.getMaxClientCnxns(), config.getClientPortListenBacklog(), false);</span>
            }

<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (config.getSecureClientPortAddress() != null) {</span>
<span class="nc" id="L173">                secureCnxnFactory = ServerCnxnFactory.createFactory();</span>
<span class="nc" id="L174">                secureCnxnFactory.configure(config.getSecureClientPortAddress(), config.getMaxClientCnxns(), config.getClientPortListenBacklog(), true);</span>
            }

<span class="nc" id="L177">            quorumPeer = getQuorumPeer();</span>
<span class="nc" id="L178">            quorumPeer.setTxnFactory(new FileTxnSnapLog(config.getDataLogDir(), config.getDataDir()));</span>
<span class="nc" id="L179">            quorumPeer.enableLocalSessions(config.areLocalSessionsEnabled());</span>
<span class="nc" id="L180">            quorumPeer.enableLocalSessionsUpgrading(config.isLocalSessionsUpgradingEnabled());</span>
            //quorumPeer.setQuorumPeers(config.getAllMembers());
<span class="nc" id="L182">            quorumPeer.setElectionType(config.getElectionAlg());</span>
<span class="nc" id="L183">            quorumPeer.setMyid(config.getServerId());</span>
<span class="nc" id="L184">            quorumPeer.setTickTime(config.getTickTime());</span>
<span class="nc" id="L185">            quorumPeer.setMinSessionTimeout(config.getMinSessionTimeout());</span>
<span class="nc" id="L186">            quorumPeer.setMaxSessionTimeout(config.getMaxSessionTimeout());</span>
<span class="nc" id="L187">            quorumPeer.setInitLimit(config.getInitLimit());</span>
<span class="nc" id="L188">            quorumPeer.setSyncLimit(config.getSyncLimit());</span>
<span class="nc" id="L189">            quorumPeer.setConnectToLearnerMasterLimit(config.getConnectToLearnerMasterLimit());</span>
<span class="nc" id="L190">            quorumPeer.setObserverMasterPort(config.getObserverMasterPort());</span>
<span class="nc" id="L191">            quorumPeer.setConfigFileName(config.getConfigFilename());</span>
<span class="nc" id="L192">            quorumPeer.setClientPortListenBacklog(config.getClientPortListenBacklog());</span>
<span class="nc" id="L193">            quorumPeer.setZKDatabase(new ZKDatabase(quorumPeer.getTxnFactory()));</span>
<span class="nc" id="L194">            quorumPeer.setQuorumVerifier(config.getQuorumVerifier(), false);</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (config.getLastSeenQuorumVerifier() != null) {</span>
<span class="nc" id="L196">                quorumPeer.setLastSeenQuorumVerifier(config.getLastSeenQuorumVerifier(), false);</span>
            }
<span class="nc" id="L198">            quorumPeer.initConfigInZKDatabase();</span>
<span class="nc" id="L199">            quorumPeer.setCnxnFactory(cnxnFactory);</span>
<span class="nc" id="L200">            quorumPeer.setSecureCnxnFactory(secureCnxnFactory);</span>
<span class="nc" id="L201">            quorumPeer.setSslQuorum(config.isSslQuorum());</span>
<span class="nc" id="L202">            quorumPeer.setUsePortUnification(config.shouldUsePortUnification());</span>
<span class="nc" id="L203">            quorumPeer.setLearnerType(config.getPeerType());</span>
<span class="nc" id="L204">            quorumPeer.setSyncEnabled(config.getSyncEnabled());</span>
<span class="nc" id="L205">            quorumPeer.setQuorumListenOnAllIPs(config.getQuorumListenOnAllIPs());</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">            if (config.sslQuorumReloadCertFiles) {</span>
<span class="nc" id="L207">                quorumPeer.getX509Util().enableCertFileReloading();</span>
            }
<span class="nc" id="L209">            quorumPeer.setMultiAddressEnabled(config.isMultiAddressEnabled());</span>
<span class="nc" id="L210">            quorumPeer.setMultiAddressReachabilityCheckEnabled(config.isMultiAddressReachabilityCheckEnabled());</span>
<span class="nc" id="L211">            quorumPeer.setMultiAddressReachabilityCheckTimeoutMs(config.getMultiAddressReachabilityCheckTimeoutMs());</span>

            // sets quorum sasl authentication configurations
<span class="nc" id="L214">            quorumPeer.setQuorumSaslEnabled(config.quorumEnableSasl);</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (quorumPeer.isQuorumSaslAuthEnabled()) {</span>
<span class="nc" id="L216">                quorumPeer.setQuorumServerSaslRequired(config.quorumServerRequireSasl);</span>
<span class="nc" id="L217">                quorumPeer.setQuorumLearnerSaslRequired(config.quorumLearnerRequireSasl);</span>
<span class="nc" id="L218">                quorumPeer.setQuorumServicePrincipal(config.quorumServicePrincipal);</span>
<span class="nc" id="L219">                quorumPeer.setQuorumServerLoginContext(config.quorumServerLoginContext);</span>
<span class="nc" id="L220">                quorumPeer.setQuorumLearnerLoginContext(config.quorumLearnerLoginContext);</span>
            }
<span class="nc" id="L222">            quorumPeer.setQuorumCnxnThreadsSize(config.quorumCnxnThreadsSize);</span>
<span class="nc" id="L223">            quorumPeer.initialize();</span>

<span class="nc bnc" id="L225" title="All 2 branches missed.">            if (config.jvmPauseMonitorToRun) {</span>
<span class="nc" id="L226">                quorumPeer.setJvmPauseMonitor(new JvmPauseMonitor(config));</span>
            }

<span class="nc" id="L229">            quorumPeer.start();</span>
<span class="nc" id="L230">            ZKAuditProvider.addZKStartStopAuditLog();</span>
<span class="nc" id="L231">            quorumPeer.join();</span>
<span class="nc" id="L232">        } catch (InterruptedException e) {</span>
            // warn, but generally this is ok
<span class="nc" id="L234">            LOG.warn(&quot;Quorum Peer interrupted&quot;, e);</span>
        } finally {
            try {
<span class="nc" id="L237">                metricsProvider.stop();</span>
<span class="nc" id="L238">            } catch (Throwable error) {</span>
<span class="nc" id="L239">                LOG.warn(&quot;Error while stopping metrics&quot;, error);</span>
<span class="nc" id="L240">            }</span>
        }
<span class="nc" id="L242">    }</span>

    // @VisibleForTesting
    protected QuorumPeer getQuorumPeer() throws SaslException {
<span class="nc" id="L246">        return new QuorumPeer();</span>
    }

    /**
     * Shutdowns properly the service, this method is not a public API.
     */
    public void close() {
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (quorumPeer != null) {</span>
            try {
<span class="nc" id="L255">                quorumPeer.shutdown();</span>
            } finally {
<span class="nc" id="L257">                quorumPeer = null;</span>
            }
        }
<span class="nc" id="L260">    }</span>

    @Override
    public String toString() {
<span class="nc" id="L264">        QuorumPeer peer = quorumPeer;</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">        return peer == null ? &quot;&quot; : peer.toString();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>