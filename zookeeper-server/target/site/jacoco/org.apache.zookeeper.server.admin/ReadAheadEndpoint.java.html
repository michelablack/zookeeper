<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReadAheadEndpoint.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache ZooKeeper - Server</a> &gt; <a href="index.source.html" class="el_package">org.apache.zookeeper.server.admin</a> &gt; <span class="el_source">ReadAheadEndpoint.java</span></div><h1>ReadAheadEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// This code was found and refactored from here:
// https://stackoverflow.com/questions/11182192/how-do-i-serve-https-and-http-for-jetty-from-one-port/40076056#40076056

package org.apache.zookeeper.server.admin;

import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.ReadPendingException;
import java.nio.channels.WritePendingException;
import org.eclipse.jetty.io.Connection;
import org.eclipse.jetty.io.EndPoint;
import org.eclipse.jetty.util.Callback;

public class ReadAheadEndpoint implements EndPoint {

    private final EndPoint endPoint;
    private final ByteBuffer start;
    private final byte[] bytes;
    private int leftToRead;
<span class="nc" id="L39">    private IOException pendingException = null;</span>

    @Override
    public InetSocketAddress getLocalAddress() {
<span class="nc" id="L43">        return endPoint.getLocalAddress();</span>
    }
    @Override
    public InetSocketAddress getRemoteAddress() {
<span class="nc" id="L47">        return endPoint.getRemoteAddress();</span>
    }
    @Override
    public boolean isOpen() {
<span class="nc" id="L51">        return endPoint.isOpen();</span>
    }
    @Override
    public long getCreatedTimeStamp() {
<span class="nc" id="L55">        return endPoint.getCreatedTimeStamp();</span>
    }
    @Override
    public boolean isOutputShutdown() {
<span class="nc" id="L59">        return endPoint.isOutputShutdown();</span>
    }
    @Override
    public boolean isInputShutdown() {
<span class="nc" id="L63">        return endPoint.isInputShutdown();</span>
    }
    @Override
    public void shutdownOutput() {
<span class="nc" id="L67">        endPoint.shutdownOutput();</span>
<span class="nc" id="L68">    }</span>
    @Override
    public void close() {
<span class="nc" id="L71">        endPoint.close();</span>
<span class="nc" id="L72">    }</span>
    @Override
    public Object getTransport() {
<span class="nc" id="L75">        return endPoint.getTransport();</span>
    }
    @Override
    public long getIdleTimeout() {
<span class="nc" id="L79">        return endPoint.getIdleTimeout();</span>
    }
    @Override
    public Connection getConnection() {
<span class="nc" id="L83">        return endPoint.getConnection();</span>
    }
    @Override
    public void onOpen() {
<span class="nc" id="L87">        endPoint.onOpen();</span>
<span class="nc" id="L88">    }</span>
    @Override
    public void onClose() {
<span class="nc" id="L91">        endPoint.onClose();</span>
<span class="nc" id="L92">    }</span>
    @Override
    public boolean isOptimizedForDirectBuffers() {
<span class="nc" id="L95">        return endPoint.isOptimizedForDirectBuffers();</span>
    }
    @Override
    public boolean isFillInterested() {
<span class="nc" id="L99">        return endPoint.isFillInterested();</span>
    }
    @Override
    public boolean tryFillInterested(Callback v) {
<span class="nc" id="L103">        return endPoint.tryFillInterested(v);</span>
    }
    @Override
    public boolean flush(ByteBuffer... v) throws IOException {
<span class="nc" id="L107">        return endPoint.flush(v);</span>
    }
    @Override
    public void setIdleTimeout(long v) {
<span class="nc" id="L111">        endPoint.setIdleTimeout(v);</span>
<span class="nc" id="L112">    }</span>
    @Override
    public void write(Callback v, ByteBuffer... b) throws WritePendingException {
<span class="nc" id="L115">        endPoint.write(v, b);</span>
<span class="nc" id="L116">    }</span>
    @Override
    public void setConnection(Connection v) {
<span class="nc" id="L119">        endPoint.setConnection(v);</span>
<span class="nc" id="L120">    }</span>
    @Override
    public void upgrade(Connection v) {
<span class="nc" id="L123">        endPoint.upgrade(v);</span>
<span class="nc" id="L124">    }</span>
    @Override
    public void fillInterested(Callback v) throws ReadPendingException {
<span class="nc" id="L127">        endPoint.fillInterested(v);</span>
<span class="nc" id="L128">    }</span>

<span class="nc" id="L130">    public ReadAheadEndpoint(final EndPoint channel, final int readAheadLength) {</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (channel == null) {</span>
<span class="nc" id="L132">            throw new IllegalArgumentException(&quot;channel cannot be null&quot;);</span>
        }

<span class="nc" id="L135">        this.endPoint = channel;</span>
<span class="nc" id="L136">        start = ByteBuffer.wrap(bytes = new byte[readAheadLength]);</span>
<span class="nc" id="L137">        start.flip();</span>
<span class="nc" id="L138">        leftToRead = readAheadLength;</span>
<span class="nc" id="L139">    }</span>

    private synchronized void readAhead() throws IOException {
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (leftToRead &gt; 0) {</span>
<span class="nc" id="L143">            int n = 0;</span>
            do {
<span class="nc" id="L145">                n = endPoint.fill(start);</span>
<span class="nc bnc" id="L146" title="All 6 branches missed.">            } while (n == 0 &amp;&amp; endPoint.isOpen() &amp;&amp; !endPoint.isInputShutdown());</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">            if (n == -1) {</span>
<span class="nc" id="L148">                leftToRead = -1;</span>
            } else {
<span class="nc" id="L150">                leftToRead -= n;</span>
            }
<span class="nc bnc" id="L152" title="All 2 branches missed.">            if (leftToRead &lt;= 0) {</span>
<span class="nc" id="L153">                start.rewind();</span>
            }
        }
<span class="nc" id="L156">    }</span>

    private int readFromStart(final ByteBuffer dst) throws IOException {
<span class="nc" id="L159">        final int n = Math.min(dst.remaining(), start.remaining());</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (n &gt; 0) {</span>
<span class="nc" id="L161">            dst.put(bytes, start.position(), n);</span>
<span class="nc" id="L162">            start.position(start.position() + n);</span>
<span class="nc" id="L163">            dst.flip();</span>
        }
<span class="nc" id="L165">        return n;</span>
    }

    @Override
    public synchronized int fill(final ByteBuffer dst) throws IOException {
<span class="nc" id="L170">        throwPendingException();</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (leftToRead &gt; 0) {</span>
<span class="nc" id="L172">            readAhead();</span>
        }
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (leftToRead &gt; 0) {</span>
<span class="nc" id="L175">            return 0;</span>
        }
<span class="nc" id="L177">        final int sr = start.remaining();</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (sr &gt; 0) {</span>
<span class="nc" id="L179">            dst.compact();</span>
<span class="nc" id="L180">            final int n = readFromStart(dst);</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">            if (n &lt; sr) {</span>
<span class="nc" id="L182">                return n;</span>
            }
        }
<span class="nc" id="L185">        return sr + endPoint.fill(dst);</span>
    }

    public byte[] getBytes() {
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (pendingException == null) {</span>
            try {
<span class="nc" id="L191">                readAhead();</span>
<span class="nc" id="L192">            } catch (IOException e) {</span>
<span class="nc" id="L193">                pendingException = e;</span>
<span class="nc" id="L194">            }</span>
        }
<span class="nc" id="L196">        byte[] ret = new byte[bytes.length];</span>
<span class="nc" id="L197">        System.arraycopy(bytes, 0, ret, 0, ret.length);</span>
<span class="nc" id="L198">        return ret;</span>
    }

    private void throwPendingException() throws IOException {
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (pendingException != null) {</span>
<span class="nc" id="L203">            IOException e = pendingException;</span>
<span class="nc" id="L204">            pendingException = null;</span>
<span class="nc" id="L205">            throw e;</span>
        }
<span class="nc" id="L207">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>