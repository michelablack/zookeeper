<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Commands.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache ZooKeeper - Server</a> &gt; <a href="index.source.html" class="el_package">org.apache.zookeeper.server.admin</a> &gt; <span class="el_source">Commands.java</span></div><h1>Commands.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.zookeeper.server.admin;

import com.fasterxml.jackson.annotation.JsonProperty;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
import java.net.InetSocketAddress;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.Set;
import java.util.SortedMap;
import java.util.TreeMap;
import java.util.stream.Collectors;
import org.apache.zookeeper.Environment;
import org.apache.zookeeper.Environment.Entry;
import org.apache.zookeeper.Version;
import org.apache.zookeeper.server.DataTree;
import org.apache.zookeeper.server.ServerCnxnFactory;
import org.apache.zookeeper.server.ServerMetrics;
import org.apache.zookeeper.server.ZooKeeperServer;
import org.apache.zookeeper.server.ZooTrace;
import org.apache.zookeeper.server.persistence.SnapshotInfo;
import org.apache.zookeeper.server.quorum.Follower;
import org.apache.zookeeper.server.quorum.FollowerZooKeeperServer;
import org.apache.zookeeper.server.quorum.Leader;
import org.apache.zookeeper.server.quorum.LeaderZooKeeperServer;
import org.apache.zookeeper.server.quorum.MultipleAddresses;
import org.apache.zookeeper.server.quorum.QuorumPeer;
import org.apache.zookeeper.server.quorum.QuorumPeer.LearnerType;
import org.apache.zookeeper.server.quorum.QuorumZooKeeperServer;
import org.apache.zookeeper.server.quorum.ReadOnlyZooKeeperServer;
import org.apache.zookeeper.server.quorum.flexible.QuorumVerifier;
import org.apache.zookeeper.server.util.ZxidUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Class containing static methods for registering and running Commands, as well
 * as default Command definitions.
 *
 * @see Command
 * @see JettyAdminServer
 */
public class Commands {

<span class="nc" id="L67">    static final Logger LOG = LoggerFactory.getLogger(Commands.class);</span>

    /** Maps command names to Command instances */
<span class="nc" id="L70">    private static Map&lt;String, Command&gt; commands = new HashMap&lt;String, Command&gt;();</span>
<span class="nc" id="L71">    private static Set&lt;String&gt; primaryNames = new HashSet&lt;String&gt;();</span>

    /**
     * Registers the given command. Registered commands can be run by passing
     * any of their names to runCommand.
     */
    public static void registerCommand(Command command) {
<span class="nc bnc" id="L78" title="All 2 branches missed.">        for (String name : command.getNames()) {</span>
<span class="nc" id="L79">            Command prev = commands.put(name, command);</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">            if (prev != null) {</span>
<span class="nc" id="L81">                LOG.warn(&quot;Re-registering command {} (primary name = {})&quot;, name, command.getPrimaryName());</span>
            }
<span class="nc" id="L83">        }</span>
<span class="nc" id="L84">        primaryNames.add(command.getPrimaryName());</span>
<span class="nc" id="L85">    }</span>

    /**
     * Run the registered command with name cmdName. Commands should not produce
     * any exceptions; any (anticipated) errors should be reported in the
     * &quot;error&quot; entry of the returned map. Likewise, if no command with the given
     * name is registered, this will be noted in the &quot;error&quot; entry.
     *
     * @param cmdName
     * @param zkServer
     * @param kwargs String-valued keyword arguments to the command
     *        (may be null if command requires no additional arguments)
     * @return Map representing response to command containing at minimum:
     *    - &quot;command&quot; key containing the command's primary name
     *    - &quot;error&quot; key containing a String error message or null if no error
     */
    public static CommandResponse runCommand(
        String cmdName,
        ZooKeeperServer zkServer,
        Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L105">        Command command = getCommand(cmdName);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (command == null) {</span>
<span class="nc" id="L107">            return new CommandResponse(cmdName, &quot;Unknown command: &quot; + cmdName);</span>
        }
<span class="nc bnc" id="L109" title="All 6 branches missed.">        if (command.isServerRequired() &amp;&amp; (zkServer == null || !zkServer.isRunning())) {</span>
<span class="nc" id="L110">            return new CommandResponse(cmdName, &quot;This ZooKeeper instance is not currently serving requests&quot;);</span>
        }
<span class="nc" id="L112">        return command.run(zkServer, kwargs);</span>
    }

    /**
     * Returns the primary names of all registered commands.
     */
    public static Set&lt;String&gt; getPrimaryNames() {
<span class="nc" id="L119">        return primaryNames;</span>
    }

    /**
     * Returns the commands registered under cmdName with registerCommand, or
     * null if no command is registered with that name.
     */
    public static Command getCommand(String cmdName) {
<span class="nc" id="L127">        return commands.get(cmdName);</span>
    }

    static {
<span class="nc" id="L131">        registerCommand(new CnxnStatResetCommand());</span>
<span class="nc" id="L132">        registerCommand(new ConfCommand());</span>
<span class="nc" id="L133">        registerCommand(new ConsCommand());</span>
<span class="nc" id="L134">        registerCommand(new DigestCommand());</span>
<span class="nc" id="L135">        registerCommand(new DirsCommand());</span>
<span class="nc" id="L136">        registerCommand(new DumpCommand());</span>
<span class="nc" id="L137">        registerCommand(new EnvCommand());</span>
<span class="nc" id="L138">        registerCommand(new GetTraceMaskCommand());</span>
<span class="nc" id="L139">        registerCommand(new InitialConfigurationCommand());</span>
<span class="nc" id="L140">        registerCommand(new IsroCommand());</span>
<span class="nc" id="L141">        registerCommand(new LastSnapshotCommand());</span>
<span class="nc" id="L142">        registerCommand(new LeaderCommand());</span>
<span class="nc" id="L143">        registerCommand(new MonitorCommand());</span>
<span class="nc" id="L144">        registerCommand(new ObserverCnxnStatResetCommand());</span>
<span class="nc" id="L145">        registerCommand(new RuokCommand());</span>
<span class="nc" id="L146">        registerCommand(new SetTraceMaskCommand());</span>
<span class="nc" id="L147">        registerCommand(new SrvrCommand());</span>
<span class="nc" id="L148">        registerCommand(new StatCommand());</span>
<span class="nc" id="L149">        registerCommand(new StatResetCommand());</span>
<span class="nc" id="L150">        registerCommand(new SyncedObserverConsCommand());</span>
<span class="nc" id="L151">        registerCommand(new SystemPropertiesCommand());</span>
<span class="nc" id="L152">        registerCommand(new VotingViewCommand());</span>
<span class="nc" id="L153">        registerCommand(new WatchCommand());</span>
<span class="nc" id="L154">        registerCommand(new WatchesByPathCommand());</span>
<span class="nc" id="L155">        registerCommand(new WatchSummaryCommand());</span>
<span class="nc" id="L156">        registerCommand(new ZabStateCommand());</span>
<span class="nc" id="L157">    }</span>

    /**
     * Reset all connection statistics.
     */
    public static class CnxnStatResetCommand extends CommandBase {

        public CnxnStatResetCommand() {
<span class="nc" id="L165">            super(Arrays.asList(&quot;connection_stat_reset&quot;, &quot;crst&quot;));</span>
<span class="nc" id="L166">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L170">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L171">            zkServer.getServerCnxnFactory().resetAllConnectionStats();</span>
<span class="nc" id="L172">            return response;</span>

        }

    }

    /**
     * Server configuration parameters.
     * @see ZooKeeperServer#getConf()
     */
    public static class ConfCommand extends CommandBase {

        public ConfCommand() {
<span class="nc" id="L185">            super(Arrays.asList(&quot;configuration&quot;, &quot;conf&quot;, &quot;config&quot;));</span>
<span class="nc" id="L186">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L190">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L191">            response.putAll(zkServer.getConf().toMap());</span>
<span class="nc" id="L192">            return response;</span>
        }

    }

    /**
     * Information on client connections to server. Returned Map contains:
     *   - &quot;connections&quot;: list of connection info objects
     * @see org.apache.zookeeper.server.ServerCnxn#getConnectionInfo(boolean)
     */
    public static class ConsCommand extends CommandBase {

        public ConsCommand() {
<span class="nc" id="L205">            super(Arrays.asList(&quot;connections&quot;, &quot;cons&quot;));</span>
<span class="nc" id="L206">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L210">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L211">            ServerCnxnFactory serverCnxnFactory = zkServer.getServerCnxnFactory();</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">            if (serverCnxnFactory != null) {</span>
<span class="nc" id="L213">                response.put(&quot;connections&quot;, serverCnxnFactory.getAllConnectionInfo(false));</span>
            } else {
<span class="nc" id="L215">                response.put(&quot;connections&quot;, Collections.emptyList());</span>
            }
<span class="nc" id="L217">            ServerCnxnFactory secureServerCnxnFactory = zkServer.getSecureServerCnxnFactory();</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">            if (secureServerCnxnFactory != null) {</span>
<span class="nc" id="L219">                response.put(&quot;secure_connections&quot;, secureServerCnxnFactory.getAllConnectionInfo(false));</span>
            } else {
<span class="nc" id="L221">                response.put(&quot;secure_connections&quot;, Collections.emptyList());</span>
            }
<span class="nc" id="L223">            return response;</span>
        }

    }

    /**
     * Information on ZK datadir and snapdir size in bytes
     */
    public static class DirsCommand extends CommandBase {

        public DirsCommand() {
<span class="nc" id="L234">            super(Arrays.asList(&quot;dirs&quot;));</span>
<span class="nc" id="L235">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L239">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L240">            response.put(&quot;datadir_size&quot;, zkServer.getDataDirSize());</span>
<span class="nc" id="L241">            response.put(&quot;logdir_size&quot;, zkServer.getLogDirSize());</span>
<span class="nc" id="L242">            return response;</span>
        }

    }

    /**
     * Information on session expirations and ephemerals. Returned map contains:
     *   - &quot;expiry_time_to_session_ids&quot;: Map&amp;lt;Long, Set&amp;lt;Long&amp;gt;&amp;gt;
     *                                   time -&amp;gt; sessions IDs of sessions that expire at time
     *   - &quot;session_id_to_ephemeral_paths&quot;: Map&amp;lt;Long, Set&amp;lt;String&amp;gt;&amp;gt;
     *                                       session ID -&amp;gt; ephemeral paths created by that session
     * @see ZooKeeperServer#getSessionExpiryMap()
     * @see ZooKeeperServer#getEphemerals()
     */
    public static class DumpCommand extends CommandBase {

        public DumpCommand() {
<span class="nc" id="L259">            super(Arrays.asList(&quot;dump&quot;));</span>
<span class="nc" id="L260">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L264">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L265">            response.put(&quot;expiry_time_to_session_ids&quot;, zkServer.getSessionExpiryMap());</span>
<span class="nc" id="L266">            response.put(&quot;session_id_to_ephemeral_paths&quot;, zkServer.getEphemerals());</span>
<span class="nc" id="L267">            return response;</span>
        }

    }

    /**
     * All defined environment variables.
     */
    public static class EnvCommand extends CommandBase {

        public EnvCommand() {
<span class="nc" id="L278">            super(Arrays.asList(&quot;environment&quot;, &quot;env&quot;, &quot;envi&quot;), false);</span>
<span class="nc" id="L279">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L283">            CommandResponse response = initializeResponse();</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">            for (Entry e : Environment.list()) {</span>
<span class="nc" id="L285">                response.put(e.getKey(), e.getValue());</span>
<span class="nc" id="L286">            }</span>
<span class="nc" id="L287">            return response;</span>
        }

    }

    /**
     * Digest histories for every specific number of txns.
     */
    public static class DigestCommand extends CommandBase {

        public DigestCommand() {
<span class="nc" id="L298">            super(Arrays.asList(&quot;hash&quot;));</span>
<span class="nc" id="L299">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L303">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L304">            response.put(&quot;digests&quot;, zkServer.getZKDatabase().getDataTree().getDigestLog());</span>
<span class="nc" id="L305">            return response;</span>
        }

    }

    /**
     * The current trace mask. Returned map contains:
     *   - &quot;tracemask&quot;: Long
     */
    public static class GetTraceMaskCommand extends CommandBase {

        public GetTraceMaskCommand() {
<span class="nc" id="L317">            super(Arrays.asList(&quot;get_trace_mask&quot;, &quot;gtmk&quot;), false);</span>
<span class="nc" id="L318">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L322">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L323">            response.put(&quot;tracemask&quot;, ZooTrace.getTextTraceLevel());</span>
<span class="nc" id="L324">            return response;</span>
        }

    }

    public static class InitialConfigurationCommand extends CommandBase {

        public InitialConfigurationCommand() {
<span class="nc" id="L332">            super(Arrays.asList(&quot;initial_configuration&quot;, &quot;icfg&quot;));</span>
<span class="nc" id="L333">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L337">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L338">            response.put(&quot;initial_configuration&quot;, zkServer.getInitialConfig());</span>
<span class="nc" id="L339">            return response;</span>
        }

    }

    /**
     * Is this server in read-only mode. Returned map contains:
     *   - &quot;is_read_only&quot;: Boolean
     */
    public static class IsroCommand extends CommandBase {

        public IsroCommand() {
<span class="nc" id="L351">            super(Arrays.asList(&quot;is_read_only&quot;, &quot;isro&quot;));</span>
<span class="nc" id="L352">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L356">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L357">            response.put(&quot;read_only&quot;, zkServer instanceof ReadOnlyZooKeeperServer);</span>
<span class="nc" id="L358">            return response;</span>
        }

    }

    /**
     * Command returns information of the last snapshot that zookeeper server
     * has finished saving to disk. During the time between the server starts up
     * and it finishes saving its first snapshot, the command returns the zxid
     * and last modified time of the snapshot file used for restoration at
     * server startup. Returned map contains:
     *   - &quot;zxid&quot;: String
     *   - &quot;timestamp&quot;: Long
     */
    public static class LastSnapshotCommand extends CommandBase {

        public LastSnapshotCommand() {
<span class="nc" id="L375">            super(Arrays.asList(&quot;last_snapshot&quot;, &quot;lsnp&quot;));</span>
<span class="nc" id="L376">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L380">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L381">            SnapshotInfo info = zkServer.getTxnLogFactory().getLastSnapshotInfo();</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">            response.put(&quot;zxid&quot;, Long.toHexString(info == null ? -1L : info.zxid));</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">            response.put(&quot;timestamp&quot;, info == null ? -1L : info.timestamp);</span>
<span class="nc" id="L384">            return response;</span>
        }

    }

    /**
     * Returns the leader status of this instance and the leader host string.
     */
    public static class LeaderCommand extends CommandBase {

        public LeaderCommand() {
<span class="nc" id="L395">            super(Arrays.asList(&quot;leader&quot;, &quot;lead&quot;));</span>
<span class="nc" id="L396">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L400">            CommandResponse response = initializeResponse();</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">            if (zkServer instanceof QuorumZooKeeperServer) {</span>
<span class="nc" id="L402">                response.put(&quot;is_leader&quot;, zkServer instanceof LeaderZooKeeperServer);</span>
<span class="nc" id="L403">                QuorumPeer peer = ((QuorumZooKeeperServer) zkServer).self;</span>
<span class="nc" id="L404">                response.put(&quot;leader_id&quot;, peer.getLeaderId());</span>
<span class="nc" id="L405">                String leaderAddress = peer.getLeaderAddress();</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">                response.put(&quot;leader_ip&quot;, leaderAddress != null ? leaderAddress : &quot;&quot;);</span>
<span class="nc" id="L407">            } else {</span>
<span class="nc" id="L408">                response.put(&quot;error&quot;, &quot;server is not initialized&quot;);</span>
            }
<span class="nc" id="L410">            return response;</span>
        }

    }

    /**
     * Some useful info for monitoring. Returned map contains:
     *   - &quot;version&quot;: String
     *                server version
     *   - &quot;avg_latency&quot;: Long
     *   - &quot;max_latency&quot;: Long
     *   - &quot;min_latency&quot;: Long
     *   - &quot;packets_received&quot;: Long
     *   - &quot;packets_sents&quot;: Long
     *   - &quot;num_alive_connections&quot;: Integer
     *   - &quot;outstanding_requests&quot;: Long
     *                             number of unprocessed requests
     *   - &quot;server_state&quot;: &quot;leader&quot;, &quot;follower&quot;, or &quot;standalone&quot;
     *   - &quot;znode_count&quot;: Integer
     *   - &quot;watch_count&quot;: Integer
     *   - &quot;ephemerals_count&quot;: Integer
     *   - &quot;approximate_data_size&quot;: Long
     *   - &quot;open_file_descriptor_count&quot;: Long (unix only)
     *   - &quot;max_file_descriptor_count&quot;: Long (unix only)
     *   - &quot;fsync_threshold_exceed_count&quot;: Long
     *   - &quot;non_mtls_conn_count&quot;: Long
     *   - &quot;non_mtls_remote_conn_count&quot;: Long
     *   - &quot;non_mtls_local_conn_count&quot;: Long
     *   - &quot;followers&quot;: Integer (leader only)
     *   - &quot;synced_followers&quot;: Integer (leader only)
     *   - &quot;pending_syncs&quot;: Integer (leader only)
     */
    public static class MonitorCommand extends CommandBase {

        public MonitorCommand() {
<span class="nc" id="L445">            super(Arrays.asList(&quot;monitor&quot;, &quot;mntr&quot;), false);</span>
<span class="nc" id="L446">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L450">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L451">            zkServer.dumpMonitorValues(response::put);</span>
<span class="nc" id="L452">            ServerMetrics.getMetrics().getMetricsProvider().dump(response::put);</span>
<span class="nc" id="L453">            return response;</span>

        }

    }

    /**
     * Reset all observer connection statistics.
     */
    public static class ObserverCnxnStatResetCommand extends CommandBase {

        public ObserverCnxnStatResetCommand() {
<span class="nc" id="L465">            super(Arrays.asList(&quot;observer_connection_stat_reset&quot;, &quot;orst&quot;));</span>
<span class="nc" id="L466">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L470">            CommandResponse response = initializeResponse();</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">            if (zkServer instanceof LeaderZooKeeperServer) {</span>
<span class="nc" id="L472">                Leader leader = ((LeaderZooKeeperServer) zkServer).getLeader();</span>
<span class="nc" id="L473">                leader.resetObserverConnectionStats();</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">            } else if (zkServer instanceof FollowerZooKeeperServer) {</span>
<span class="nc" id="L475">                Follower follower = ((FollowerZooKeeperServer) zkServer).getFollower();</span>
<span class="nc" id="L476">                follower.resetObserverConnectionStats();</span>
            }
<span class="nc" id="L478">            return response;</span>
        }

    }

    /**
     * No-op command, check if the server is running
     */
    public static class RuokCommand extends CommandBase {

        public RuokCommand() {
<span class="nc" id="L489">            super(Arrays.asList(&quot;ruok&quot;));</span>
<span class="nc" id="L490">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L494">            return initializeResponse();</span>
        }

    }

    /**
     * Sets the trace mask. Required arguments:
     *   - &quot;traceMask&quot;: Long
     *  Returned Map contains:
     *   - &quot;tracemask&quot;: Long
     */
    public static class SetTraceMaskCommand extends CommandBase {

        public SetTraceMaskCommand() {
<span class="nc" id="L508">            super(Arrays.asList(&quot;set_trace_mask&quot;, &quot;stmk&quot;), false);</span>
<span class="nc" id="L509">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L513">            CommandResponse response = initializeResponse();</span>
            long traceMask;
<span class="nc bnc" id="L515" title="All 2 branches missed.">            if (!kwargs.containsKey(&quot;traceMask&quot;)) {</span>
<span class="nc" id="L516">                response.put(&quot;error&quot;, &quot;setTraceMask requires long traceMask argument&quot;);</span>
<span class="nc" id="L517">                return response;</span>
            }
            try {
<span class="nc" id="L520">                traceMask = Long.parseLong(kwargs.get(&quot;traceMask&quot;));</span>
<span class="nc" id="L521">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L522">                response.put(&quot;error&quot;, &quot;setTraceMask requires long traceMask argument, got &quot; + kwargs.get(&quot;traceMask&quot;));</span>
<span class="nc" id="L523">                return response;</span>
<span class="nc" id="L524">            }</span>

<span class="nc" id="L526">            ZooTrace.setTextTraceLevel(traceMask);</span>
<span class="nc" id="L527">            response.put(&quot;tracemask&quot;, traceMask);</span>
<span class="nc" id="L528">            return response;</span>
        }

    }

    /**
     * Server information. Returned map contains:
     *   - &quot;version&quot;: String
     *                version of server
     *   - &quot;read_only&quot;: Boolean
     *                  is server in read-only mode
     *   - &quot;server_stats&quot;: ServerStats object
     *   - &quot;node_count&quot;: Integer
     */
    public static class SrvrCommand extends CommandBase {

        public SrvrCommand() {
<span class="nc" id="L545">            super(Arrays.asList(&quot;server_stats&quot;, &quot;srvr&quot;));</span>
<span class="nc" id="L546">        }</span>

        // Allow subclasses (e.g. StatCommand) to specify their own names
        protected SrvrCommand(List&lt;String&gt; names) {
<span class="nc" id="L550">            super(names);</span>
<span class="nc" id="L551">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L555">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L556">            LOG.info(&quot;running stat&quot;);</span>
<span class="nc" id="L557">            response.put(&quot;version&quot;, Version.getFullVersion());</span>
<span class="nc" id="L558">            response.put(&quot;read_only&quot;, zkServer instanceof ReadOnlyZooKeeperServer);</span>
<span class="nc" id="L559">            response.put(&quot;server_stats&quot;, zkServer.serverStats());</span>
<span class="nc" id="L560">            response.put(&quot;client_response&quot;, zkServer.serverStats().getClientResponseStats());</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">            if (zkServer instanceof LeaderZooKeeperServer) {</span>
<span class="nc" id="L562">                Leader leader = ((LeaderZooKeeperServer) zkServer).getLeader();</span>
<span class="nc" id="L563">                response.put(&quot;proposal_stats&quot;, leader.getProposalStats());</span>
            }
<span class="nc" id="L565">            response.put(&quot;node_count&quot;, zkServer.getZKDatabase().getNodeCount());</span>
<span class="nc" id="L566">            return response;</span>
        }

    }

    /**
     * Same as SrvrCommand but has extra &quot;connections&quot; entry.
     */
    public static class StatCommand extends SrvrCommand {

        public StatCommand() {
<span class="nc" id="L577">            super(Arrays.asList(&quot;stats&quot;, &quot;stat&quot;));</span>
<span class="nc" id="L578">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L582">            CommandResponse response = super.run(zkServer, kwargs);</span>

            final Iterable&lt;Map&lt;String, Object&gt;&gt; connections;
<span class="nc bnc" id="L585" title="All 2 branches missed.">            if (zkServer.getServerCnxnFactory() != null) {</span>
<span class="nc" id="L586">                connections = zkServer.getServerCnxnFactory().getAllConnectionInfo(true);</span>
            } else {
<span class="nc" id="L588">                connections = Collections.emptyList();</span>
            }
<span class="nc" id="L590">            response.put(&quot;connections&quot;, connections);</span>

            final Iterable&lt;Map&lt;String, Object&gt;&gt; secureConnections;
<span class="nc bnc" id="L593" title="All 2 branches missed.">            if (zkServer.getSecureServerCnxnFactory() != null) {</span>
<span class="nc" id="L594">                secureConnections = zkServer.getSecureServerCnxnFactory().getAllConnectionInfo(true);</span>
            } else {
<span class="nc" id="L596">                secureConnections = Collections.emptyList();</span>
            }
<span class="nc" id="L598">            response.put(&quot;secure_connections&quot;, secureConnections);</span>
<span class="nc" id="L599">            return response;</span>
        }

    }

    /**
     * Resets server statistics.
     */
    public static class StatResetCommand extends CommandBase {

        public StatResetCommand() {
<span class="nc" id="L610">            super(Arrays.asList(&quot;stat_reset&quot;, &quot;srst&quot;));</span>
<span class="nc" id="L611">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L615">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L616">            zkServer.serverStats().reset();</span>
<span class="nc" id="L617">            return response;</span>
        }

    }

    /**
     * Information on observer connections to server. Returned Map contains:
     *   - &quot;synced_observers&quot;: Integer (leader/follower only)
     *   - &quot;observers&quot;: list of observer learner handler info objects (leader/follower only)
     * @see org.apache.zookeeper.server.quorum.LearnerHandler#getLearnerHandlerInfo()
     */
    public static class SyncedObserverConsCommand extends CommandBase {

        public SyncedObserverConsCommand() {
<span class="nc" id="L631">            super(Arrays.asList(&quot;observers&quot;, &quot;obsr&quot;));</span>
<span class="nc" id="L632">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {

<span class="nc" id="L637">            CommandResponse response = initializeResponse();</span>

<span class="nc bnc" id="L639" title="All 2 branches missed.">            if (zkServer instanceof LeaderZooKeeperServer) {</span>
<span class="nc" id="L640">                Leader leader = ((LeaderZooKeeperServer) zkServer).getLeader();</span>

<span class="nc" id="L642">                response.put(&quot;synced_observers&quot;, leader.getObservingLearners().size());</span>
<span class="nc" id="L643">                response.put(&quot;observers&quot;, leader.getObservingLearnersInfo());</span>
<span class="nc" id="L644">                return response;</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">            } else if (zkServer instanceof FollowerZooKeeperServer) {</span>
<span class="nc" id="L646">                Follower follower = ((FollowerZooKeeperServer) zkServer).getFollower();</span>
<span class="nc" id="L647">                Integer syncedObservers = follower.getSyncedObserverSize();</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">                if (syncedObservers != null) {</span>
<span class="nc" id="L649">                    response.put(&quot;synced_observers&quot;, syncedObservers);</span>
<span class="nc" id="L650">                    response.put(&quot;observers&quot;, follower.getSyncedObserversInfo());</span>
<span class="nc" id="L651">                    return response;</span>
                }
            }

<span class="nc" id="L655">            response.put(&quot;synced_observers&quot;, 0);</span>
<span class="nc" id="L656">            response.put(&quot;observers&quot;, Collections.emptySet());</span>
<span class="nc" id="L657">            return response;</span>
        }

    }

    /**
     * All defined system properties.
     */
    public static class SystemPropertiesCommand extends CommandBase {

        public SystemPropertiesCommand() {
<span class="nc" id="L668">            super(Arrays.asList(&quot;system_properties&quot;, &quot;sysp&quot;), false);</span>
<span class="nc" id="L669">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L673">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L674">            Properties systemProperties = System.getProperties();</span>
<span class="nc" id="L675">            SortedMap&lt;String, String&gt; sortedSystemProperties = new TreeMap&lt;&gt;();</span>
<span class="nc" id="L676">            systemProperties.forEach((k, v) -&gt; sortedSystemProperties.put(k.toString(), v.toString()));</span>
<span class="nc" id="L677">            response.putAll(sortedSystemProperties);</span>
<span class="nc" id="L678">            return response;</span>
        }

    }

    /**
     * Returns the current ensemble configuration information.
     * It provides list of current voting members in the ensemble.
     */
    public static class VotingViewCommand extends CommandBase {

        public VotingViewCommand() {
<span class="nc" id="L690">            super(Arrays.asList(&quot;voting_view&quot;));</span>
<span class="nc" id="L691">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L695">            CommandResponse response = initializeResponse();</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">            if (zkServer instanceof QuorumZooKeeperServer) {</span>
<span class="nc" id="L697">                QuorumPeer peer = ((QuorumZooKeeperServer) zkServer).self;</span>
<span class="nc" id="L698">                Map&lt;Long, QuorumServerView&gt; votingView = peer.getVotingView().entrySet().stream()</span>
<span class="nc" id="L699">                        .collect(Collectors.toMap(Map.Entry::getKey, e -&gt; new QuorumServerView(e.getValue())));</span>
<span class="nc" id="L700">                response.put(&quot;current_config&quot;, votingView);</span>
<span class="nc" id="L701">            } else {</span>
<span class="nc" id="L702">                response.put(&quot;current_config&quot;, Collections.emptyMap());</span>
            }
<span class="nc" id="L704">            return response;</span>
        }

        @SuppressFBWarnings(value = &quot;URF_UNREAD_FIELD&quot;, justification = &quot;class is used only for JSON serialization&quot;)
        private static class QuorumServerView {

            @JsonProperty
            private List&lt;String&gt; serverAddresses;

            @JsonProperty
            private List&lt;String&gt; electionAddresses;

            @JsonProperty
            private String clientAddress;

            @JsonProperty
            private String learnerType;

<span class="nc" id="L722">            public QuorumServerView(QuorumPeer.QuorumServer quorumServer) {</span>
<span class="nc" id="L723">                this.serverAddresses = getMultiAddressString(quorumServer.addr);</span>
<span class="nc" id="L724">                this.electionAddresses = getMultiAddressString(quorumServer.electionAddr);</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">                this.learnerType = quorumServer.type.equals(LearnerType.PARTICIPANT) ? &quot;participant&quot; : &quot;observer&quot;;</span>
<span class="nc" id="L726">                this.clientAddress = getAddressString(quorumServer.clientAddr);</span>
<span class="nc" id="L727">            }</span>

            private static List&lt;String&gt; getMultiAddressString(MultipleAddresses multipleAddresses) {
<span class="nc bnc" id="L730" title="All 2 branches missed.">                if (multipleAddresses == null) {</span>
<span class="nc" id="L731">                    return Collections.emptyList();</span>
                }

<span class="nc" id="L734">                return multipleAddresses.getAllAddresses().stream()</span>
<span class="nc" id="L735">                        .map(QuorumServerView::getAddressString)</span>
<span class="nc" id="L736">                        .collect(Collectors.toList());</span>
            }

            private static String getAddressString(InetSocketAddress address) {
<span class="nc bnc" id="L740" title="All 2 branches missed.">                if (address == null) {</span>
<span class="nc" id="L741">                    return &quot;&quot;;</span>
                }
<span class="nc" id="L743">                return String.format(&quot;%s:%d&quot;, QuorumPeer.QuorumServer.delimitedHostString(address), address.getPort());</span>
            }
       }

    }

    /**
     * Watch information aggregated by session. Returned Map contains:
     *   - &quot;session_id_to_watched_paths&quot;: Map&amp;lt;Long, Set&amp;lt;String&amp;gt;&amp;gt; session ID -&amp;gt; watched paths
     * @see DataTree#getWatches()
     * @see DataTree#getWatches()
     */
    public static class WatchCommand extends CommandBase {

        public WatchCommand() {
<span class="nc" id="L758">            super(Arrays.asList(&quot;watches&quot;, &quot;wchc&quot;));</span>
<span class="nc" id="L759">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L763">            DataTree dt = zkServer.getZKDatabase().getDataTree();</span>
<span class="nc" id="L764">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L765">            response.put(&quot;session_id_to_watched_paths&quot;, dt.getWatches().toMap());</span>
<span class="nc" id="L766">            return response;</span>
        }

    }

    /**
     * Watch information aggregated by path. Returned Map contains:
     *   - &quot;path_to_session_ids&quot;: Map&amp;lt;String, Set&amp;lt;Long&amp;gt;&amp;gt; path -&amp;gt; session IDs of sessions watching path
     * @see DataTree#getWatchesByPath()
     */
    public static class WatchesByPathCommand extends CommandBase {

        public WatchesByPathCommand() {
<span class="nc" id="L779">            super(Arrays.asList(&quot;watches_by_path&quot;, &quot;wchp&quot;));</span>
<span class="nc" id="L780">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L784">            DataTree dt = zkServer.getZKDatabase().getDataTree();</span>
<span class="nc" id="L785">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L786">            response.put(&quot;path_to_session_ids&quot;, dt.getWatchesByPath().toMap());</span>
<span class="nc" id="L787">            return response;</span>
        }

    }

    /**
     * Summarized watch information.
     * @see DataTree#getWatchesSummary()
     */
    public static class WatchSummaryCommand extends CommandBase {

        public WatchSummaryCommand() {
<span class="nc" id="L799">            super(Arrays.asList(&quot;watch_summary&quot;, &quot;wchs&quot;));</span>
<span class="nc" id="L800">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L804">            DataTree dt = zkServer.getZKDatabase().getDataTree();</span>
<span class="nc" id="L805">            CommandResponse response = initializeResponse();</span>
<span class="nc" id="L806">            response.putAll(dt.getWatchesSummary().toMap());</span>
<span class="nc" id="L807">            return response;</span>
        }

    }

    /**
     * Returns the current phase of Zab protocol that peer is running.
     * It can be in one of these phases: ELECTION, DISCOVERY, SYNCHRONIZATION, BROADCAST
     */
    public static class ZabStateCommand extends CommandBase {

        public ZabStateCommand() {
<span class="nc" id="L819">            super(Arrays.asList(&quot;zabstate&quot;), false);</span>
<span class="nc" id="L820">        }</span>

        @Override
        public CommandResponse run(ZooKeeperServer zkServer, Map&lt;String, String&gt; kwargs) {
<span class="nc" id="L824">            CommandResponse response = initializeResponse();</span>
<span class="nc bnc" id="L825" title="All 2 branches missed.">            if (zkServer instanceof QuorumZooKeeperServer) {</span>
<span class="nc" id="L826">                QuorumPeer peer = ((QuorumZooKeeperServer) zkServer).self;</span>
<span class="nc" id="L827">                QuorumPeer.ZabState zabState = peer.getZabState();</span>
<span class="nc" id="L828">                QuorumVerifier qv = peer.getQuorumVerifier();</span>

<span class="nc" id="L830">                QuorumPeer.QuorumServer voter = qv.getVotingMembers().get(peer.getId());</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">                boolean voting = (</span>
                        voter != null
<span class="nc bnc" id="L833" title="All 2 branches missed.">                                &amp;&amp; voter.addr.equals(peer.getQuorumAddress())</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">                                &amp;&amp; voter.electionAddr.equals(peer.getElectionAddress())</span>
                );
<span class="nc" id="L836">                response.put(&quot;myid&quot;, zkServer.getConf().getServerId());</span>
<span class="nc" id="L837">                response.put(&quot;is_leader&quot;, zkServer instanceof LeaderZooKeeperServer);</span>
<span class="nc" id="L838">                response.put(&quot;quorum_address&quot;, peer.getQuorumAddress());</span>
<span class="nc" id="L839">                response.put(&quot;election_address&quot;, peer.getElectionAddress());</span>
<span class="nc" id="L840">                response.put(&quot;client_address&quot;, peer.getClientAddress());</span>
<span class="nc" id="L841">                response.put(&quot;voting&quot;, voting);</span>
<span class="nc" id="L842">                long lastProcessedZxid = zkServer.getZKDatabase().getDataTreeLastProcessedZxid();</span>
<span class="nc" id="L843">                response.put(&quot;last_zxid&quot;, &quot;0x&quot; + ZxidUtils.zxidToString(lastProcessedZxid));</span>
<span class="nc" id="L844">                response.put(&quot;zab_epoch&quot;, ZxidUtils.getEpochFromZxid(lastProcessedZxid));</span>
<span class="nc" id="L845">                response.put(&quot;zab_counter&quot;, ZxidUtils.getCounterFromZxid(lastProcessedZxid));</span>
<span class="nc" id="L846">                response.put(&quot;zabstate&quot;, zabState.name().toLowerCase());</span>
<span class="nc" id="L847">            } else {</span>
<span class="nc" id="L848">                response.put(&quot;voting&quot;, false);</span>
<span class="nc" id="L849">                response.put(&quot;zabstate&quot;, &quot;&quot;);</span>
            }
<span class="nc" id="L851">            return response;</span>
        }

    }

    private Commands() {
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>