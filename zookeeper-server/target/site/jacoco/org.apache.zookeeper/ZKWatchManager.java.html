<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ZKWatchManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache ZooKeeper - Server</a> &gt; <a href="index.source.html" class="el_package">org.apache.zookeeper</a> &gt; <span class="el_source">ZKWatchManager.java</span></div><h1>ZKWatchManager.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.zookeeper;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import org.apache.zookeeper.server.watch.PathParentIterator;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Manage watchers and handle events generated by the {@link ClientCnxn} object.
 *
 * This class is intended to be packaged-private so that it doesn't serve
 * as part of ZooKeeper client API.
 */
class ZKWatchManager implements ClientWatchManager {

<span class="nc" id="L39">    private static final Logger LOG = LoggerFactory.getLogger(ZKWatchManager.class);</span>

<span class="nc" id="L41">    private final Map&lt;String, Set&lt;Watcher&gt;&gt; dataWatches = new HashMap&lt;&gt;();</span>
<span class="nc" id="L42">    private final Map&lt;String, Set&lt;Watcher&gt;&gt; existWatches = new HashMap&lt;&gt;();</span>
<span class="nc" id="L43">    private final Map&lt;String, Set&lt;Watcher&gt;&gt; childWatches = new HashMap&lt;&gt;();</span>
<span class="nc" id="L44">    private final Map&lt;String, Set&lt;Watcher&gt;&gt; persistentWatches = new HashMap&lt;&gt;();</span>
<span class="nc" id="L45">    private final Map&lt;String, Set&lt;Watcher&gt;&gt; persistentRecursiveWatches = new HashMap&lt;&gt;();</span>
    private final boolean disableAutoWatchReset;

    private volatile Watcher defaultWatcher;

<span class="nc" id="L50">    ZKWatchManager(boolean disableAutoWatchReset, Watcher defaultWatcher) {</span>
<span class="nc" id="L51">        this.disableAutoWatchReset = disableAutoWatchReset;</span>
<span class="nc" id="L52">        this.defaultWatcher = defaultWatcher;</span>
<span class="nc" id="L53">    }</span>

    void setDefaultWatcher(Watcher defaultWatcher) {
<span class="nc" id="L56">        this.defaultWatcher = defaultWatcher;</span>
<span class="nc" id="L57">    }</span>

    Watcher getDefaultWatcher() {
<span class="nc" id="L60">        return defaultWatcher;</span>
    }

    List&lt;String&gt; getDataWatchList() {
<span class="nc" id="L64">        synchronized (dataWatches) {</span>
<span class="nc" id="L65">            return new ArrayList&lt;&gt;(dataWatches.keySet());</span>
        }
    }

    List&lt;String&gt; getChildWatchList() {
<span class="nc" id="L70">        synchronized (childWatches) {</span>
<span class="nc" id="L71">            return new ArrayList&lt;&gt;(childWatches.keySet());</span>
        }
    }

    List&lt;String&gt; getExistWatchList() {
<span class="nc" id="L76">        synchronized (existWatches) {</span>
<span class="nc" id="L77">            return new ArrayList&lt;&gt;(existWatches.keySet());</span>
        }
    }

    List&lt;String&gt; getPersistentWatchList() {
<span class="nc" id="L82">        synchronized (persistentWatches) {</span>
<span class="nc" id="L83">            return new ArrayList&lt;&gt;(persistentWatches.keySet());</span>
        }
    }

    List&lt;String&gt; getPersistentRecursiveWatchList() {
<span class="nc" id="L88">        synchronized (persistentRecursiveWatches) {</span>
<span class="nc" id="L89">            return new ArrayList&lt;&gt;(persistentRecursiveWatches.keySet());</span>
        }
    }

    Map&lt;String, Set&lt;Watcher&gt;&gt; getDataWatches() {
<span class="nc" id="L94">        return dataWatches;</span>
    }

    Map&lt;String, Set&lt;Watcher&gt;&gt; getExistWatches() {
<span class="nc" id="L98">        return existWatches;</span>
    }

    Map&lt;String, Set&lt;Watcher&gt;&gt; getChildWatches() {
<span class="nc" id="L102">        return childWatches;</span>
    }

    Map&lt;String, Set&lt;Watcher&gt;&gt; getPersistentWatches() {
<span class="nc" id="L106">        return persistentWatches;</span>
    }

    Map&lt;String, Set&lt;Watcher&gt;&gt; getPersistentRecursiveWatches() {
<span class="nc" id="L110">        return persistentRecursiveWatches;</span>
    }

    private void addTo(Set&lt;Watcher&gt; from, Set&lt;Watcher&gt; to) {
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (from != null) {</span>
<span class="nc" id="L115">            to.addAll(from);</span>
        }
<span class="nc" id="L117">    }</span>

    public Map&lt;Watcher.Event.EventType, Set&lt;Watcher&gt;&gt; removeWatcher(
        String clientPath,
        Watcher watcher,
        Watcher.WatcherType watcherType,
        boolean local,
        int rc
    ) throws KeeperException {
        // Validate the provided znode path contains the given watcher of
        // watcherType
<span class="nc" id="L128">        containsWatcher(clientPath, watcher, watcherType);</span>

<span class="nc" id="L130">        Map&lt;Watcher.Event.EventType, Set&lt;Watcher&gt;&gt; removedWatchers = new HashMap&lt;&gt;();</span>
<span class="nc" id="L131">        HashSet&lt;Watcher&gt; childWatchersToRem = new HashSet&lt;&gt;();</span>
<span class="nc" id="L132">        removedWatchers.put(Watcher.Event.EventType.ChildWatchRemoved, childWatchersToRem);</span>
<span class="nc" id="L133">        HashSet&lt;Watcher&gt; dataWatchersToRem = new HashSet&lt;&gt;();</span>
<span class="nc" id="L134">        removedWatchers.put(Watcher.Event.EventType.DataWatchRemoved, dataWatchersToRem);</span>
<span class="nc" id="L135">        HashSet&lt;Watcher&gt; persistentWatchersToRem = new HashSet&lt;&gt;();</span>
<span class="nc" id="L136">        removedWatchers.put(Watcher.Event.EventType.PersistentWatchRemoved, persistentWatchersToRem);</span>
<span class="nc" id="L137">        boolean removedWatcher = false;</span>
<span class="nc bnc" id="L138" title="All 4 branches missed.">        switch (watcherType) {</span>
        case Children: {
<span class="nc" id="L140">            synchronized (childWatches) {</span>
<span class="nc" id="L141">                removedWatcher = removeWatches(childWatches, watcher, clientPath, local, rc, childWatchersToRem);</span>
<span class="nc" id="L142">            }</span>
<span class="nc" id="L143">            break;</span>
        }
        case Data: {
<span class="nc" id="L146">            synchronized (dataWatches) {</span>
<span class="nc" id="L147">                removedWatcher = removeWatches(dataWatches, watcher, clientPath, local, rc, dataWatchersToRem);</span>
<span class="nc" id="L148">            }</span>

<span class="nc" id="L150">            synchronized (existWatches) {</span>
<span class="nc" id="L151">                boolean removedDataWatcher = removeWatches(existWatches, watcher, clientPath, local, rc, dataWatchersToRem);</span>
<span class="nc" id="L152">                removedWatcher |= removedDataWatcher;</span>
<span class="nc" id="L153">            }</span>
<span class="nc" id="L154">            break;</span>
        }
        case Any: {
<span class="nc" id="L157">            synchronized (childWatches) {</span>
<span class="nc" id="L158">                removedWatcher = removeWatches(childWatches, watcher, clientPath, local, rc, childWatchersToRem);</span>
<span class="nc" id="L159">            }</span>

<span class="nc" id="L161">            synchronized (dataWatches) {</span>
<span class="nc" id="L162">                boolean removedDataWatcher = removeWatches(dataWatches, watcher, clientPath, local, rc, dataWatchersToRem);</span>
<span class="nc" id="L163">                removedWatcher |= removedDataWatcher;</span>
<span class="nc" id="L164">            }</span>

<span class="nc" id="L166">            synchronized (existWatches) {</span>
<span class="nc" id="L167">                boolean removedDataWatcher = removeWatches(existWatches, watcher, clientPath, local, rc, dataWatchersToRem);</span>
<span class="nc" id="L168">                removedWatcher |= removedDataWatcher;</span>
<span class="nc" id="L169">            }</span>

<span class="nc" id="L171">            synchronized (persistentWatches) {</span>
<span class="nc" id="L172">                boolean removedPersistentWatcher = removeWatches(persistentWatches,</span>
                        watcher, clientPath, local, rc, persistentWatchersToRem);
<span class="nc" id="L174">                removedWatcher |= removedPersistentWatcher;</span>
<span class="nc" id="L175">            }</span>

<span class="nc" id="L177">            synchronized (persistentRecursiveWatches) {</span>
<span class="nc" id="L178">                boolean removedPersistentRecursiveWatcher = removeWatches(persistentRecursiveWatches,</span>
                        watcher, clientPath, local, rc, persistentWatchersToRem);
<span class="nc" id="L180">                removedWatcher |= removedPersistentRecursiveWatcher;</span>
<span class="nc" id="L181">            }</span>
        }
        }
        // Watcher function doesn't exists for the specified params
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (!removedWatcher) {</span>
<span class="nc" id="L186">            throw new KeeperException.NoWatcherException(clientPath);</span>
        }
<span class="nc" id="L188">        return removedWatchers;</span>
    }

    private boolean contains(String path, Watcher watcherObj, Map&lt;String, Set&lt;Watcher&gt;&gt; pathVsWatchers) {
<span class="nc" id="L192">        boolean watcherExists = true;</span>
<span class="nc bnc" id="L193" title="All 4 branches missed.">        if (pathVsWatchers == null || pathVsWatchers.size() == 0) {</span>
<span class="nc" id="L194">            watcherExists = false;</span>
        } else {
<span class="nc" id="L196">            Set&lt;Watcher&gt; watchers = pathVsWatchers.get(path);</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (watchers == null) {</span>
<span class="nc" id="L198">                watcherExists = false;</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">            } else if (watcherObj == null) {</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">                watcherExists = watchers.size() &gt; 0;</span>
            } else {
<span class="nc" id="L202">                watcherExists = watchers.contains(watcherObj);</span>
            }
        }
<span class="nc" id="L205">        return watcherExists;</span>
    }

    /**
     * Validate the provided znode path contains the given watcher and
     * watcherType
     *
     * @param path
     *            - client path
     * @param watcher
     *            - watcher object reference
     * @param watcherType
     *            - type of the watcher
     * @throws KeeperException.NoWatcherException
     */
    void containsWatcher(String path, Watcher watcher, Watcher.WatcherType watcherType) throws
            KeeperException.NoWatcherException {
<span class="nc" id="L222">        boolean containsWatcher = false;</span>
<span class="nc bnc" id="L223" title="All 4 branches missed.">        switch (watcherType) {</span>
        case Children: {
<span class="nc" id="L225">            synchronized (childWatches) {</span>
<span class="nc" id="L226">                containsWatcher = contains(path, watcher, childWatches);</span>
<span class="nc" id="L227">            }</span>

<span class="nc" id="L229">            synchronized (persistentWatches) {</span>
<span class="nc" id="L230">                boolean contains_temp = contains(path, watcher,</span>
                        persistentWatches);
<span class="nc" id="L232">                containsWatcher |= contains_temp;</span>
<span class="nc" id="L233">            }</span>

<span class="nc" id="L235">            synchronized (persistentRecursiveWatches) {</span>
<span class="nc" id="L236">                boolean contains_temp = contains(path, watcher,</span>
                        persistentRecursiveWatches);
<span class="nc" id="L238">                containsWatcher |= contains_temp;</span>
<span class="nc" id="L239">            }</span>
<span class="nc" id="L240">            break;</span>
        }
        case Data: {
<span class="nc" id="L243">            synchronized (dataWatches) {</span>
<span class="nc" id="L244">                containsWatcher = contains(path, watcher, dataWatches);</span>
<span class="nc" id="L245">            }</span>

<span class="nc" id="L247">            synchronized (existWatches) {</span>
<span class="nc" id="L248">                boolean contains_temp = contains(path, watcher, existWatches);</span>
<span class="nc" id="L249">                containsWatcher |= contains_temp;</span>
<span class="nc" id="L250">            }</span>

<span class="nc" id="L252">            synchronized (persistentWatches) {</span>
<span class="nc" id="L253">                boolean contains_temp = contains(path, watcher,</span>
                        persistentWatches);
<span class="nc" id="L255">                containsWatcher |= contains_temp;</span>
<span class="nc" id="L256">            }</span>

<span class="nc" id="L258">            synchronized (persistentRecursiveWatches) {</span>
<span class="nc" id="L259">                boolean contains_temp = contains(path, watcher,</span>
                        persistentRecursiveWatches);
<span class="nc" id="L261">                containsWatcher |= contains_temp;</span>
<span class="nc" id="L262">            }</span>
<span class="nc" id="L263">            break;</span>
        }
        case Any: {
<span class="nc" id="L266">            synchronized (childWatches) {</span>
<span class="nc" id="L267">                containsWatcher = contains(path, watcher, childWatches);</span>
<span class="nc" id="L268">            }</span>

<span class="nc" id="L270">            synchronized (dataWatches) {</span>
<span class="nc" id="L271">                boolean contains_temp = contains(path, watcher, dataWatches);</span>
<span class="nc" id="L272">                containsWatcher |= contains_temp;</span>
<span class="nc" id="L273">            }</span>

<span class="nc" id="L275">            synchronized (existWatches) {</span>
<span class="nc" id="L276">                boolean contains_temp = contains(path, watcher, existWatches);</span>
<span class="nc" id="L277">                containsWatcher |= contains_temp;</span>
<span class="nc" id="L278">            }</span>

<span class="nc" id="L280">            synchronized (persistentWatches) {</span>
<span class="nc" id="L281">                boolean contains_temp = contains(path, watcher,</span>
                        persistentWatches);
<span class="nc" id="L283">                containsWatcher |= contains_temp;</span>
<span class="nc" id="L284">            }</span>

<span class="nc" id="L286">            synchronized (persistentRecursiveWatches) {</span>
<span class="nc" id="L287">                boolean contains_temp = contains(path, watcher,</span>
                        persistentRecursiveWatches);
<span class="nc" id="L289">                containsWatcher |= contains_temp;</span>
<span class="nc" id="L290">            }</span>
        }
        }
        // Watcher function doesn't exists for the specified params
<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (!containsWatcher) {</span>
<span class="nc" id="L295">            throw new KeeperException.NoWatcherException(path);</span>
        }
<span class="nc" id="L297">    }</span>

    protected boolean removeWatches(
        Map&lt;String, Set&lt;Watcher&gt;&gt; pathVsWatcher,
        Watcher watcher,
        String path,
        boolean local,
        int rc,
        Set&lt;Watcher&gt; removedWatchers) throws KeeperException {
<span class="nc bnc" id="L306" title="All 4 branches missed.">        if (!local &amp;&amp; rc != KeeperException.Code.OK.intValue()) {</span>
<span class="nc" id="L307">            throw KeeperException.create(KeeperException.Code.get(rc), path);</span>
        }
<span class="nc" id="L309">        boolean success = false;</span>
        // When local flag is true, remove watchers for the given path
        // irrespective of rc. Otherwise shouldn't remove watchers locally
        // when sees failure from server.
<span class="nc bnc" id="L313" title="All 6 branches missed.">        if (rc == KeeperException.Code.OK.intValue() || (local &amp;&amp; rc != KeeperException.Code.OK.intValue())) {</span>
            // Remove all the watchers for the given path
<span class="nc bnc" id="L315" title="All 2 branches missed.">            if (watcher == null) {</span>
<span class="nc" id="L316">                Set&lt;Watcher&gt; pathWatchers = pathVsWatcher.remove(path);</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">                if (pathWatchers != null) {</span>
                    // found path watchers
<span class="nc" id="L319">                    removedWatchers.addAll(pathWatchers);</span>
<span class="nc" id="L320">                    success = true;</span>
                }
<span class="nc" id="L322">            } else {</span>
<span class="nc" id="L323">                Set&lt;Watcher&gt; watchers = pathVsWatcher.get(path);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">                if (watchers != null) {</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">                    if (watchers.remove(watcher)) {</span>
                        // found path watcher
<span class="nc" id="L327">                        removedWatchers.add(watcher);</span>
                        // cleanup &lt;path vs watchlist&gt;
<span class="nc bnc" id="L329" title="All 2 branches missed.">                        if (watchers.size() &lt;= 0) {</span>
<span class="nc" id="L330">                            pathVsWatcher.remove(path);</span>
                        }
<span class="nc" id="L332">                        success = true;</span>
                    }
                }
            }
        }
<span class="nc" id="L337">        return success;</span>
    }

    /* (non-Javadoc)
     * @see org.apache.zookeeper.ClientWatchManager#materialize(Event.KeeperState,
     *                                                        Event.EventType, java.lang.String)
     */
    @Override
    public Set&lt;Watcher&gt; materialize(
        Watcher.Event.KeeperState state,
        Watcher.Event.EventType type,
        String clientPath
    ) {
<span class="nc" id="L350">        final Set&lt;Watcher&gt; result = new HashSet&lt;&gt;();</span>

<span class="nc bnc" id="L352" title="All 5 branches missed.">        switch (type) {</span>
        case None:
<span class="nc bnc" id="L354" title="All 2 branches missed.">            if (defaultWatcher != null) {</span>
<span class="nc" id="L355">                result.add(defaultWatcher);</span>
            }

<span class="nc bnc" id="L358" title="All 4 branches missed.">            boolean clear = disableAutoWatchReset &amp;&amp; state != Watcher.Event.KeeperState.SyncConnected;</span>
<span class="nc" id="L359">            synchronized (dataWatches) {</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">                for (Set&lt;Watcher&gt; ws : dataWatches.values()) {</span>
<span class="nc" id="L361">                    result.addAll(ws);</span>
<span class="nc" id="L362">                }</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">                if (clear) {</span>
<span class="nc" id="L364">                    dataWatches.clear();</span>
                }
<span class="nc" id="L366">            }</span>

<span class="nc" id="L368">            synchronized (existWatches) {</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">                for (Set&lt;Watcher&gt; ws : existWatches.values()) {</span>
<span class="nc" id="L370">                    result.addAll(ws);</span>
<span class="nc" id="L371">                }</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">                if (clear) {</span>
<span class="nc" id="L373">                    existWatches.clear();</span>
                }
<span class="nc" id="L375">            }</span>

<span class="nc" id="L377">            synchronized (childWatches) {</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">                for (Set&lt;Watcher&gt; ws : childWatches.values()) {</span>
<span class="nc" id="L379">                    result.addAll(ws);</span>
<span class="nc" id="L380">                }</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">                if (clear) {</span>
<span class="nc" id="L382">                    childWatches.clear();</span>
                }
<span class="nc" id="L384">            }</span>

<span class="nc" id="L386">            synchronized (persistentWatches) {</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">                for (Set&lt;Watcher&gt; ws: persistentWatches.values()) {</span>
<span class="nc" id="L388">                    result.addAll(ws);</span>
<span class="nc" id="L389">                }</span>
<span class="nc" id="L390">            }</span>

<span class="nc" id="L392">            synchronized (persistentRecursiveWatches) {</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">                for (Set&lt;Watcher&gt; ws: persistentRecursiveWatches.values()) {</span>
<span class="nc" id="L394">                    result.addAll(ws);</span>
<span class="nc" id="L395">                }</span>
<span class="nc" id="L396">            }</span>

<span class="nc" id="L398">            return result;</span>
        case NodeDataChanged:
        case NodeCreated:
<span class="nc" id="L401">            synchronized (dataWatches) {</span>
<span class="nc" id="L402">                addTo(dataWatches.remove(clientPath), result);</span>
<span class="nc" id="L403">            }</span>
<span class="nc" id="L404">            synchronized (existWatches) {</span>
<span class="nc" id="L405">                addTo(existWatches.remove(clientPath), result);</span>
<span class="nc" id="L406">            }</span>
<span class="nc" id="L407">            addPersistentWatches(clientPath, result);</span>
<span class="nc" id="L408">            break;</span>
        case NodeChildrenChanged:
<span class="nc" id="L410">            synchronized (childWatches) {</span>
<span class="nc" id="L411">                addTo(childWatches.remove(clientPath), result);</span>
<span class="nc" id="L412">            }</span>
<span class="nc" id="L413">            addPersistentWatches(clientPath, result);</span>
<span class="nc" id="L414">            break;</span>
        case NodeDeleted:
<span class="nc" id="L416">            synchronized (dataWatches) {</span>
<span class="nc" id="L417">                addTo(dataWatches.remove(clientPath), result);</span>
<span class="nc" id="L418">            }</span>
            // TODO This shouldn't be needed, but just in case
<span class="nc" id="L420">            synchronized (existWatches) {</span>
<span class="nc" id="L421">                Set&lt;Watcher&gt; list = existWatches.remove(clientPath);</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">                if (list != null) {</span>
<span class="nc" id="L423">                    addTo(list, result);</span>
<span class="nc" id="L424">                    LOG.warn(&quot;We are triggering an exists watch for delete! Shouldn't happen!&quot;);</span>
                }
<span class="nc" id="L426">            }</span>
<span class="nc" id="L427">            synchronized (childWatches) {</span>
<span class="nc" id="L428">                addTo(childWatches.remove(clientPath), result);</span>
<span class="nc" id="L429">            }</span>
<span class="nc" id="L430">            addPersistentWatches(clientPath, result);</span>
<span class="nc" id="L431">            break;</span>
        default:
<span class="nc" id="L433">            String errorMsg = String.format(</span>
                &quot;Unhandled watch event type %s with state %s on path %s&quot;,
                type,
                state,
                clientPath);
<span class="nc" id="L438">            LOG.error(errorMsg);</span>
<span class="nc" id="L439">            throw new RuntimeException(errorMsg);</span>
        }

<span class="nc" id="L442">        return result;</span>
    }

    private void addPersistentWatches(String clientPath, Set&lt;Watcher&gt; result) {
<span class="nc" id="L446">        synchronized (persistentWatches) {</span>
<span class="nc" id="L447">            addTo(persistentWatches.get(clientPath), result);</span>
<span class="nc" id="L448">        }</span>
<span class="nc" id="L449">        synchronized (persistentRecursiveWatches) {</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">            for (String path : PathParentIterator.forAll(clientPath).asIterable()) {</span>
<span class="nc" id="L451">                addTo(persistentRecursiveWatches.get(path), result);</span>
<span class="nc" id="L452">            }</span>
<span class="nc" id="L453">        }</span>
<span class="nc" id="L454">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>