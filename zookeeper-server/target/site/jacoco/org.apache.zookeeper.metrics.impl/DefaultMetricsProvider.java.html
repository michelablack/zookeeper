<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultMetricsProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache ZooKeeper - Server</a> &gt; <a href="index.source.html" class="el_package">org.apache.zookeeper.metrics.impl</a> &gt; <span class="el_source">DefaultMetricsProvider.java</span></div><h1>DefaultMetricsProvider.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.zookeeper.metrics.impl;

import java.util.Objects;
import java.util.Properties;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import java.util.function.BiConsumer;
import org.apache.zookeeper.metrics.Counter;
import org.apache.zookeeper.metrics.CounterSet;
import org.apache.zookeeper.metrics.Gauge;
import org.apache.zookeeper.metrics.GaugeSet;
import org.apache.zookeeper.metrics.MetricsContext;
import org.apache.zookeeper.metrics.MetricsProvider;
import org.apache.zookeeper.metrics.MetricsProviderLifeCycleException;
import org.apache.zookeeper.metrics.Summary;
import org.apache.zookeeper.metrics.SummarySet;
import org.apache.zookeeper.server.metric.AvgMinMaxCounter;
import org.apache.zookeeper.server.metric.AvgMinMaxCounterSet;
import org.apache.zookeeper.server.metric.AvgMinMaxPercentileCounter;
import org.apache.zookeeper.server.metric.AvgMinMaxPercentileCounterSet;
import org.apache.zookeeper.server.metric.SimpleCounter;
import org.apache.zookeeper.server.metric.SimpleCounterSet;

/**
 * Default implementation of {@link MetricsProvider}.&lt;br&gt;
 * It does not implement a real hierarchy of contexts, but metrics are flattened
 * in a single namespace.&lt;br&gt;
 * It is mostly useful to make the legacy 4 letter words interface work as
 * expected.
 */
<span class="fc" id="L49">public class DefaultMetricsProvider implements MetricsProvider {</span>

<span class="fc" id="L51">    private final DefaultMetricsContext rootMetricsContext = new DefaultMetricsContext();</span>

    @Override
    public void configure(Properties configuration) throws MetricsProviderLifeCycleException {
<span class="nc" id="L55">    }</span>

    @Override
    public void start() throws MetricsProviderLifeCycleException {
<span class="nc" id="L59">    }</span>

    @Override
    public MetricsContext getRootContext() {
<span class="fc" id="L63">        return rootMetricsContext;</span>
    }

    @Override
    public void stop() {
        // release all references to external objects
<span class="nc" id="L69">        rootMetricsContext.gauges.clear();</span>
<span class="nc" id="L70">        rootMetricsContext.gaugeSets.clear();</span>
<span class="nc" id="L71">    }</span>

    @Override
    public void dump(BiConsumer&lt;String, Object&gt; sink) {
<span class="nc" id="L75">        rootMetricsContext.dump(sink);</span>
<span class="nc" id="L76">    }</span>

    @Override
    public void resetAllValues() {
<span class="nc" id="L80">        rootMetricsContext.reset();</span>
<span class="nc" id="L81">    }</span>

<span class="fc" id="L83">    private static final class DefaultMetricsContext implements MetricsContext {</span>

<span class="fc" id="L85">        private final ConcurrentMap&lt;String, Gauge&gt; gauges = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc" id="L86">        private final ConcurrentMap&lt;String, GaugeSet&gt; gaugeSets = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc" id="L87">        private final ConcurrentMap&lt;String, SimpleCounter&gt; counters = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc" id="L88">        private final ConcurrentMap&lt;String, SimpleCounterSet&gt; counterSets = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc" id="L89">        private final ConcurrentMap&lt;String, AvgMinMaxCounter&gt; basicSummaries = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc" id="L90">        private final ConcurrentMap&lt;String, AvgMinMaxPercentileCounter&gt; summaries = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc" id="L91">        private final ConcurrentMap&lt;String, AvgMinMaxCounterSet&gt; basicSummarySets = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc" id="L92">        private final ConcurrentMap&lt;String, AvgMinMaxPercentileCounterSet&gt; summarySets = new ConcurrentHashMap&lt;&gt;();</span>

        @Override
        public MetricsContext getContext(String name) {
            // no hierarchy yet
<span class="nc" id="L97">            return this;</span>
        }

        @Override
        public Counter getCounter(String name) {
<span class="fc" id="L102">            return counters.computeIfAbsent(name, (n) -&gt; {</span>
<span class="fc" id="L103">                return new SimpleCounter(n);</span>
            });
        }

        @Override
        public CounterSet getCounterSet(final String name) {
<span class="fc" id="L109">            Objects.requireNonNull(name, &quot;Cannot register a CounterSet with null name&quot;);</span>
<span class="fc" id="L110">            return counterSets.computeIfAbsent(name, SimpleCounterSet::new);</span>
        }

        @Override
        public void registerGauge(String name, Gauge gauge) {
<span class="nc" id="L115">            Objects.requireNonNull(gauge, &quot;Cannot register a null Gauge for &quot; + name);</span>
<span class="nc" id="L116">            gauges.put(name, gauge);</span>
<span class="nc" id="L117">        }</span>

        @Override
        public void unregisterGauge(String name) {
<span class="nc" id="L121">            gauges.remove(name);</span>
<span class="nc" id="L122">        }</span>

        @Override
        public void registerGaugeSet(final String name, final GaugeSet gaugeSet) {
<span class="nc" id="L126">            Objects.requireNonNull(name, &quot;Cannot register a GaugeSet with null name&quot;);</span>
<span class="nc" id="L127">            Objects.requireNonNull(gaugeSet, &quot;Cannot register a null GaugeSet for &quot; + name);</span>
<span class="nc" id="L128">            gaugeSets.put(name, gaugeSet);</span>
<span class="nc" id="L129">        }</span>

        @Override
        public void unregisterGaugeSet(final String name) {
<span class="nc" id="L133">            Objects.requireNonNull(name, &quot;Cannot unregister GaugeSet with null name&quot;);</span>
<span class="nc" id="L134">            gaugeSets.remove(name);</span>
<span class="nc" id="L135">        }</span>

        @Override
        public Summary getSummary(String name, DetailLevel detailLevel) {
<span class="fc bfc" id="L139" title="All 2 branches covered.">            if (detailLevel == DetailLevel.BASIC) {</span>
<span class="fc" id="L140">                return basicSummaries.computeIfAbsent(name, (n) -&gt; {</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">                    if (summaries.containsKey(n)) {</span>
<span class="nc" id="L142">                        throw new IllegalArgumentException(&quot;Already registered a non basic summary as &quot; + n);</span>
                    }
<span class="fc" id="L144">                    return new AvgMinMaxCounter(name);</span>
                });
            } else {
<span class="fc" id="L147">                return summaries.computeIfAbsent(name, (n) -&gt; {</span>
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">                    if (basicSummaries.containsKey(n)) {</span>
<span class="nc" id="L149">                        throw new IllegalArgumentException(&quot;Already registered a basic summary as &quot; + n);</span>
                    }
<span class="fc" id="L151">                    return new AvgMinMaxPercentileCounter(name);</span>
                });
            }
        }

        @Override
        public SummarySet getSummarySet(String name, DetailLevel detailLevel) {
<span class="fc bfc" id="L158" title="All 2 branches covered.">            if (detailLevel == DetailLevel.BASIC) {</span>
<span class="fc" id="L159">                return basicSummarySets.computeIfAbsent(name, (n) -&gt; {</span>
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">                    if (summarySets.containsKey(n)) {</span>
<span class="nc" id="L161">                        throw new IllegalArgumentException(&quot;Already registered a non basic summary set as &quot; + n);</span>
                    }
<span class="fc" id="L163">                    return new AvgMinMaxCounterSet(name);</span>
                });
            } else {
<span class="fc" id="L166">                return summarySets.computeIfAbsent(name, (n) -&gt; {</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">                    if (basicSummarySets.containsKey(n)) {</span>
<span class="nc" id="L168">                        throw new IllegalArgumentException(&quot;Already registered a basic summary set as &quot; + n);</span>
                    }
<span class="fc" id="L170">                    return new AvgMinMaxPercentileCounterSet(name);</span>
                });
            }
        }

        void dump(BiConsumer&lt;String, Object&gt; sink) {
<span class="nc" id="L176">            gauges.forEach((name, metric) -&gt; {</span>
<span class="nc" id="L177">                Number value = metric.get();</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                if (value != null) {</span>
<span class="nc" id="L179">                    sink.accept(name, value);</span>
                }
<span class="nc" id="L181">            });</span>

<span class="nc" id="L183">            gaugeSets.forEach((name, gaugeSet) -&gt;</span>
<span class="nc" id="L184">                gaugeSet.values().forEach((key, value) -&gt; {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                    if (key != null) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                        sink.accept(key + &quot;_&quot; + name, value != null ? value : 0);</span>
                    }
<span class="nc" id="L188">                })</span>
            );

<span class="nc" id="L191">            counters.values().forEach(metric -&gt; {</span>
<span class="nc" id="L192">                metric.values().forEach(sink);</span>
<span class="nc" id="L193">            });</span>
<span class="nc" id="L194">            counterSets.values().forEach(metric -&gt; {</span>
<span class="nc" id="L195">                metric.values().forEach(sink);</span>
<span class="nc" id="L196">            });</span>
<span class="nc" id="L197">            basicSummaries.values().forEach(metric -&gt; {</span>
<span class="nc" id="L198">                metric.values().forEach(sink);</span>
<span class="nc" id="L199">            });</span>
<span class="nc" id="L200">            summaries.values().forEach(metric -&gt; {</span>
<span class="nc" id="L201">                metric.values().forEach(sink);</span>
<span class="nc" id="L202">            });</span>
<span class="nc" id="L203">            basicSummarySets.values().forEach(metric -&gt; {</span>
<span class="nc" id="L204">                metric.values().forEach(sink);</span>
<span class="nc" id="L205">            });</span>
<span class="nc" id="L206">            summarySets.values().forEach(metric -&gt; {</span>
<span class="nc" id="L207">                metric.values().forEach(sink);</span>
<span class="nc" id="L208">            });</span>
<span class="nc" id="L209">        }</span>

        void reset() {
<span class="nc" id="L212">            counters.values().forEach(metric -&gt; {</span>
<span class="nc" id="L213">                metric.reset();</span>
<span class="nc" id="L214">            });</span>
<span class="nc" id="L215">            counterSets.values().forEach(metric -&gt; {</span>
<span class="nc" id="L216">                metric.reset();</span>
<span class="nc" id="L217">            });</span>
<span class="nc" id="L218">            basicSummaries.values().forEach(metric -&gt; {</span>
<span class="nc" id="L219">                metric.reset();</span>
<span class="nc" id="L220">            });</span>
<span class="nc" id="L221">            summaries.values().forEach(metric -&gt; {</span>
<span class="nc" id="L222">                metric.reset();</span>
<span class="nc" id="L223">            });</span>
<span class="nc" id="L224">            basicSummarySets.values().forEach(metric -&gt; {</span>
<span class="nc" id="L225">                metric.reset();</span>
<span class="nc" id="L226">            });</span>
<span class="nc" id="L227">            summarySets.values().forEach(metric -&gt; {</span>
<span class="nc" id="L228">                metric.reset();</span>
<span class="nc" id="L229">            });</span>
            // no need to reset gauges
<span class="nc" id="L231">        }</span>

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>