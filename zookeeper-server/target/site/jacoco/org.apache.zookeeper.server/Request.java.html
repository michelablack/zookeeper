<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Request.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache ZooKeeper - Server</a> &gt; <a href="index.source.html" class="el_package">org.apache.zookeeper.server</a> &gt; <span class="el_source">Request.java</span></div><h1>Request.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *uuuuu
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;/RequuuAS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.zookeeper.server;

import static java.nio.charset.StandardCharsets.UTF_8;
import java.nio.ByteBuffer;
import java.util.List;
import org.apache.jute.Record;
import org.apache.zookeeper.KeeperException;
import org.apache.zookeeper.ZooDefs.OpCode;
import org.apache.zookeeper.common.Time;
import org.apache.zookeeper.data.Id;
import org.apache.zookeeper.metrics.Summary;
import org.apache.zookeeper.metrics.SummarySet;
import org.apache.zookeeper.server.quorum.LearnerHandler;
import org.apache.zookeeper.server.quorum.flexible.QuorumVerifier;
import org.apache.zookeeper.server.util.AuthUtil;
import org.apache.zookeeper.txn.TxnDigest;
import org.apache.zookeeper.txn.TxnHeader;

/**
 * This is the structure that represents a request moving through a chain of
 * RequestProcessors. There are various pieces of information that is tacked
 * onto the request as it is processed.
 */
public class Request {

<span class="fc" id="L44">    public static final Request requestOfDeath = new Request(null, 0, 0, 0, null, null);</span>

    // Considers a request stale if the request's connection has closed. Enabled
    // by default.
<span class="fc" id="L48">    private static volatile boolean staleConnectionCheck = Boolean.parseBoolean(System.getProperty(&quot;zookeeper.request_stale_connection_check&quot;, &quot;true&quot;));</span>

    // Considers a request stale if the request latency is higher than its
    // associated session timeout. Disabled by default.
<span class="fc" id="L52">    private static volatile boolean staleLatencyCheck = Boolean.parseBoolean(System.getProperty(&quot;zookeeper.request_stale_latency_check&quot;, &quot;false&quot;));</span>

<span class="fc" id="L54">    public Request(ServerCnxn cnxn, long sessionId, int xid, int type, ByteBuffer bb, List&lt;Id&gt; authInfo) {</span>
<span class="fc" id="L55">        this.cnxn = cnxn;</span>
<span class="fc" id="L56">        this.sessionId = sessionId;</span>
<span class="fc" id="L57">        this.cxid = xid;</span>
<span class="fc" id="L58">        this.type = type;</span>
<span class="fc" id="L59">        this.request = bb;</span>
<span class="fc" id="L60">        this.authInfo = authInfo;</span>
<span class="fc" id="L61">    }</span>

<span class="nc" id="L63">    public Request(long sessionId, int xid, int type, TxnHeader hdr, Record txn, long zxid) {</span>
<span class="nc" id="L64">        this.sessionId = sessionId;</span>
<span class="nc" id="L65">        this.cxid = xid;</span>
<span class="nc" id="L66">        this.type = type;</span>
<span class="nc" id="L67">        this.hdr = hdr;</span>
<span class="nc" id="L68">        this.txn = txn;</span>
<span class="nc" id="L69">        this.zxid = zxid;</span>
<span class="nc" id="L70">        this.request = null;</span>
<span class="nc" id="L71">        this.cnxn = null;</span>
<span class="nc" id="L72">        this.authInfo = null;</span>
<span class="nc" id="L73">    }</span>

    public final long sessionId;

    public final int cxid;

    public final int type;

    public final ByteBuffer request;

    public final ServerCnxn cnxn;

    private TxnHeader hdr;

    private Record txn;

<span class="pc" id="L89">    public long zxid = -1;</span>

    public final List&lt;Id&gt; authInfo;

<span class="pc" id="L93">    public final long createTime = Time.currentElapsedTime();</span>

<span class="pc" id="L95">    public long prepQueueStartTime = -1;</span>

<span class="pc" id="L97">    public long prepStartTime = -1;</span>

<span class="pc" id="L99">    public long commitProcQueueStartTime = -1;</span>

<span class="pc" id="L101">    public long commitRecvTime = -1;</span>

    public long syncQueueStartTime;

    public long requestThrottleQueueTime;

    private Object owner;

    private KeeperException e;

<span class="pc" id="L111">    public QuorumVerifier qv = null;</span>

    private TxnDigest txnDigest;

<span class="pc" id="L115">    private boolean isThrottledFlag = false;</span>

    public boolean isThrottled() {
<span class="nc" id="L118">      return isThrottledFlag;</span>
    }

    public void setIsThrottled(boolean val) {
<span class="nc" id="L122">      isThrottledFlag = val;</span>
<span class="nc" id="L123">    }</span>

    public boolean isThrottlable() {
<span class="nc bnc" id="L126" title="All 6 branches missed.">        return this.type != OpCode.ping</span>
                &amp;&amp; this.type != OpCode.closeSession
                &amp;&amp; this.type != OpCode.createSession;
    }

    /**
     * If this is a create or close request for a local-only session.
     */
<span class="pc" id="L134">    private boolean isLocalSession = false;</span>

<span class="pc" id="L136">    private int largeRequestSize = -1;</span>

    public boolean isLocalSession() {
<span class="nc" id="L139">        return isLocalSession;</span>
    }

    public void setLocalSession(boolean isLocalSession) {
<span class="nc" id="L143">        this.isLocalSession = isLocalSession;</span>
<span class="nc" id="L144">    }</span>

    public void setLargeRequestSize(int size) {
<span class="nc" id="L147">        largeRequestSize = size;</span>
<span class="nc" id="L148">    }</span>

    public int getLargeRequestSize() {
<span class="nc" id="L151">        return largeRequestSize;</span>
    }

    public Object getOwner() {
<span class="nc" id="L155">        return owner;</span>
    }

    public void setOwner(Object owner) {
<span class="nc" id="L159">        this.owner = owner;</span>
<span class="nc" id="L160">    }</span>

    public TxnHeader getHdr() {
<span class="nc" id="L163">        return hdr;</span>
    }

    public void setHdr(TxnHeader hdr) {
<span class="nc" id="L167">        this.hdr = hdr;</span>
<span class="nc" id="L168">    }</span>

    public Record getTxn() {
<span class="nc" id="L171">        return txn;</span>
    }

    public void setTxn(Record txn) {
<span class="nc" id="L175">        this.txn = txn;</span>
<span class="nc" id="L176">    }</span>

    public ServerCnxn getConnection() {
<span class="nc" id="L179">        return cnxn;</span>
    }

    public static boolean getStaleLatencyCheck() {
<span class="nc" id="L183">        return staleLatencyCheck;</span>
    }

    public static void setStaleLatencyCheck(boolean check) {
<span class="nc" id="L187">        staleLatencyCheck = check;</span>
<span class="nc" id="L188">    }</span>

    public static boolean getStaleConnectionCheck() {
<span class="nc" id="L191">        return staleConnectionCheck;</span>
    }

    public static void setStaleConnectionCheck(boolean check) {
<span class="nc" id="L195">        staleConnectionCheck = check;</span>
<span class="nc" id="L196">    }</span>

    public boolean isStale() {
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (cnxn == null) {</span>
<span class="nc" id="L200">            return false;</span>
        }

        // closeSession requests should be able to outlive the session in order
        // to clean-up state.
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (type == OpCode.closeSession) {</span>
<span class="nc" id="L206">            return false;</span>
        }

<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (staleConnectionCheck) {</span>
            // If the connection is closed, consider the request stale.
<span class="nc bnc" id="L211" title="All 4 branches missed.">            if (cnxn.isStale() || cnxn.isInvalid()) {</span>
<span class="nc" id="L212">                return true;</span>
            }
        }

<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (staleLatencyCheck) {</span>
            // If the request latency is higher than session timeout, consider
            // the request stale.
<span class="nc" id="L219">            long currentTime = Time.currentElapsedTime();</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">            return (currentTime - createTime) &gt; cnxn.getSessionTimeout();</span>
        }

<span class="nc" id="L223">        return false;</span>
    }

    /**
     * A prior request was dropped on this request's connection and
     * therefore this request must also be dropped to ensure correct
     * ordering semantics.
     */
    public boolean mustDrop() {
<span class="nc bnc" id="L232" title="All 4 branches missed.">        return ((cnxn != null) &amp;&amp; cnxn.isInvalid());</span>
    }

    /**
     * is the packet type a valid packet in zookeeper
     *
     * @param type
     *                the type of the packet
     * @return true if a valid packet, false if not
     */
    static boolean isValid(int type) {
        // make sure this is always synchronized with Zoodefs!!
<span class="nc bnc" id="L244" title="All 3 branches missed.">        switch (type) {</span>
        case OpCode.notification:
<span class="nc" id="L246">            return false;</span>
        case OpCode.check:
        case OpCode.closeSession:
        case OpCode.create:
        case OpCode.create2:
        case OpCode.createTTL:
        case OpCode.createContainer:
        case OpCode.createSession:
        case OpCode.delete:
        case OpCode.deleteContainer:
        case OpCode.exists:
        case OpCode.getACL:
        case OpCode.getChildren:
        case OpCode.getAllChildrenNumber:
        case OpCode.getChildren2:
        case OpCode.getData:
        case OpCode.getEphemerals:
        case OpCode.multi:
        case OpCode.multiRead:
        case OpCode.ping:
        case OpCode.reconfig:
        case OpCode.setACL:
        case OpCode.setData:
        case OpCode.setWatches:
        case OpCode.setWatches2:
        case OpCode.sync:
        case OpCode.checkWatches:
        case OpCode.removeWatches:
        case OpCode.addWatch:
        case OpCode.whoAmI:
<span class="nc" id="L276">            return true;</span>
        default:
<span class="nc" id="L278">            return false;</span>
        }
    }

    public boolean isQuorum() {
<span class="nc bnc" id="L283" title="All 4 branches missed.">        switch (this.type) {</span>
        case OpCode.exists:
        case OpCode.getACL:
        case OpCode.getChildren:
        case OpCode.getAllChildrenNumber:
        case OpCode.getChildren2:
        case OpCode.getData:
        case OpCode.getEphemerals:
        case OpCode.multiRead:
        case OpCode.whoAmI:
<span class="nc" id="L293">            return false;</span>
        case OpCode.create:
        case OpCode.create2:
        case OpCode.createTTL:
        case OpCode.createContainer:
        case OpCode.error:
        case OpCode.delete:
        case OpCode.deleteContainer:
        case OpCode.setACL:
        case OpCode.setData:
        case OpCode.check:
        case OpCode.multi:
        case OpCode.reconfig:
<span class="nc" id="L306">            return true;</span>
        case OpCode.closeSession:
        case OpCode.createSession:
<span class="nc bnc" id="L309" title="All 2 branches missed.">            return !this.isLocalSession;</span>
        default:
<span class="nc" id="L311">            return false;</span>
        }
    }

    public static String op2String(int op) {
<span class="pc bpc" id="L316" title="32 of 33 branches missed.">        switch (op) {</span>
            case OpCode.notification:
<span class="nc" id="L318">                return &quot;notification&quot;;</span>
            case OpCode.create:
<span class="fc" id="L320">                return &quot;create&quot;;</span>
            case OpCode.delete:
<span class="nc" id="L322">                return &quot;delete&quot;;</span>
            case OpCode.exists:
<span class="nc" id="L324">                return &quot;exists&quot;;</span>
            case OpCode.getData:
<span class="nc" id="L326">                return &quot;getData&quot;;</span>
            case OpCode.setData:
<span class="nc" id="L328">                return &quot;setData&quot;;</span>
            case OpCode.getACL:
<span class="nc" id="L330">                return &quot;getACL&quot;;</span>
            case OpCode.setACL:
<span class="nc" id="L332">                return &quot;setACL&quot;;</span>
            case OpCode.getChildren:
<span class="nc" id="L334">                return &quot;getChildren&quot;;</span>
            case OpCode.sync:
<span class="nc" id="L336">                return &quot;sync&quot;;</span>
            case OpCode.ping:
<span class="nc" id="L338">                return &quot;ping&quot;;</span>
            case OpCode.getChildren2:
<span class="nc" id="L340">                return &quot;getChildren2&quot;;</span>
            case OpCode.check:
<span class="nc" id="L342">                return &quot;check&quot;;</span>
            case OpCode.multi:
<span class="nc" id="L344">                return &quot;multi&quot;;</span>
            case OpCode.create2:
<span class="nc" id="L346">                return &quot;create2&quot;;</span>
            case OpCode.reconfig:
<span class="nc" id="L348">                return &quot;reconfig&quot;;</span>
            case OpCode.checkWatches:
<span class="nc" id="L350">                return &quot;checkWatches&quot;;</span>
            case OpCode.removeWatches:
<span class="nc" id="L352">                return &quot;removeWatches&quot;;</span>
            case OpCode.createContainer:
<span class="nc" id="L354">                return &quot;createContainer&quot;;</span>
            case OpCode.deleteContainer:
<span class="nc" id="L356">                return &quot;deleteContainer&quot;;</span>
            case OpCode.createTTL:
<span class="nc" id="L358">                return &quot;createTtl&quot;;</span>
            case OpCode.multiRead:
<span class="nc" id="L360">                return &quot;multiRead&quot;;</span>
            case OpCode.auth:
<span class="nc" id="L362">                return &quot;auth&quot;;</span>
            case OpCode.setWatches:
<span class="nc" id="L364">                return &quot;setWatches&quot;;</span>
            case OpCode.setWatches2:
<span class="nc" id="L366">                return &quot;setWatches2&quot;;</span>
            case OpCode.sasl:
<span class="nc" id="L368">                return &quot;sasl&quot;;</span>
            case OpCode.getEphemerals:
<span class="nc" id="L370">                return &quot;getEphemerals&quot;;</span>
            case OpCode.getAllChildrenNumber:
<span class="nc" id="L372">                return &quot;getAllChildrenNumber&quot;;</span>
            case OpCode.createSession:
<span class="nc" id="L374">                return &quot;createSession&quot;;</span>
            case OpCode.closeSession:
<span class="nc" id="L376">                return &quot;closeSession&quot;;</span>
            case OpCode.error:
<span class="nc" id="L378">                return &quot;error&quot;;</span>
            case OpCode.whoAmI:
<span class="nc" id="L380">                return &quot;whoAmI&quot;;</span>
            default:
<span class="nc" id="L382">                return &quot;unknown &quot; + op;</span>
        }
    }

    @Override
    public String toString() {
<span class="nc" id="L388">        StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L389">        sb.append(&quot;sessionid:0x&quot;).append(Long.toHexString(sessionId))</span>
<span class="nc" id="L390">          .append(&quot; type:&quot;).append(op2String(type))</span>
<span class="nc" id="L391">          .append(&quot; cxid:0x&quot;).append(Long.toHexString(cxid))</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">          .append(&quot; zxid:0x&quot;).append(Long.toHexString(hdr == null ? -2 : hdr.getZxid()))</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">          .append(&quot; txntype:&quot;).append(hdr == null ? &quot;unknown&quot; : &quot;&quot; + hdr.getType());</span>

        // best effort to print the path assoc with this request
<span class="nc" id="L396">        String path = &quot;n/a&quot;;</span>
<span class="nc bnc" id="L397" title="All 10 branches missed.">        if (type != OpCode.createSession</span>
            &amp;&amp; type != OpCode.setWatches
            &amp;&amp; type != OpCode.setWatches2
            &amp;&amp; type != OpCode.closeSession
            &amp;&amp; request != null
<span class="nc bnc" id="L402" title="All 2 branches missed.">            &amp;&amp; request.remaining() &gt;= 4) {</span>
            try {
                // make sure we don't mess with request itself
<span class="nc" id="L405">                ByteBuffer rbuf = request.asReadOnlyBuffer();</span>
<span class="nc" id="L406">                rbuf.clear();</span>
<span class="nc" id="L407">                int pathLen = rbuf.getInt();</span>
                // sanity check
<span class="nc bnc" id="L409" title="All 6 branches missed.">                if (pathLen &gt;= 0 &amp;&amp; pathLen &lt; 4096 &amp;&amp; rbuf.remaining() &gt;= pathLen) {</span>
<span class="nc" id="L410">                    byte[] b = new byte[pathLen];</span>
<span class="nc" id="L411">                    rbuf.get(b);</span>
<span class="nc" id="L412">                    path = new String(b, UTF_8);</span>
                }
<span class="nc" id="L414">            } catch (Exception e) {</span>
                // ignore - can't find the path, will output &quot;n/a&quot; instead
<span class="nc" id="L416">            }</span>
        }
<span class="nc" id="L418">        sb.append(&quot; reqpath:&quot;).append(path);</span>

<span class="nc" id="L420">        return sb.toString();</span>
    }

    public void setException(KeeperException e) {
<span class="nc" id="L424">        this.e = e;</span>
<span class="nc" id="L425">    }</span>

    public KeeperException getException() {
<span class="nc" id="L428">        return e;</span>
    }

    public void logLatency(Summary metric) {
<span class="nc" id="L432">        logLatency(metric, Time.currentWallTime());</span>
<span class="nc" id="L433">    }</span>

    public void logLatency(Summary metric, long currentTime) {
<span class="nc bnc" id="L436" title="All 2 branches missed.">        if (hdr != null) {</span>
            /* Request header is created by leader. If there is clock drift
             * latency might be negative. Headers use wall time, not
             * CLOCK_MONOTONIC.
             */
<span class="nc" id="L441">            long latency = currentTime - hdr.getTime();</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">            if (latency &gt;= 0) {</span>
<span class="nc" id="L443">                metric.add(latency);</span>
            }
        }
<span class="nc" id="L446">    }</span>

    public void logLatency(SummarySet metric, String key, long currentTime) {
<span class="nc bnc" id="L449" title="All 2 branches missed.">        if (hdr != null) {</span>
            /* Request header is created by leader. If there is clock drift
             * latency might be negative. Headers use wall time, not
             * CLOCK_MONOTONIC.
             */
<span class="nc" id="L454">            long latency = currentTime - hdr.getTime();</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">            if (latency &gt;= 0) {</span>
<span class="nc" id="L456">                metric.add(key, latency);</span>
            }
        }
<span class="nc" id="L459">    }</span>

    public void logLatency(SummarySet metric, String key) {
<span class="nc" id="L462">        logLatency(metric, key, Time.currentWallTime());</span>
<span class="nc" id="L463">    }</span>

    /**
     * Returns a formatted, comma-separated list of the user IDs
     * associated with this {@code Request}, or {@code null} if no
     * user IDs were found.
     *
     * The return value is used for audit logging.  While it may be
     * easy on the eyes, it is underspecified: it does not mention the
     * corresponding {@code scheme}, nor are its components escaped.
     * This is not a security feature.
     *
     * @return a comma-separated list of user IDs, or {@code null} if
     * no user IDs were found.
     */
    public String getUsersForAudit() {
<span class="nc" id="L479">        return AuthUtil.getUsers(authInfo);</span>
    }

    public TxnDigest getTxnDigest() {
<span class="nc" id="L483">        return txnDigest;</span>
    }

    public void setTxnDigest(TxnDigest txnDigest) {
<span class="nc" id="L487">        this.txnDigest = txnDigest;</span>
<span class="nc" id="L488">    }</span>

    public boolean isFromLearner() {
<span class="nc" id="L491">        return owner instanceof LearnerHandler;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>